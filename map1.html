<!DOCTYPE HTML>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù‚Ø±ÙŠØ¨Ø©</title>
  <link rel="stylesheet" href="assets/css/main.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

  <style>
    /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
    #intro-screen {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: #ffffff; color: #000;
      display: flex; justify-content: center; align-items: center; flex-direction: column;
      font-family: sans-serif;
      z-index: 9999;
    }
    #intro-screen img { margin-bottom: 20px; max-width: 200px; }

    /* Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù… */
    .container-map {
      display:flex; flex-direction:column;
      max-width:1200px; margin:30px auto; gap:10px; padding:0 20px; position:relative;
    }
    #map { width:100%; height:500px; border-radius:12px; }
    #lists { width:100%; background:#f9f9f9; padding:10px 20px; border-radius:12px; max-height:300px; overflow-y:auto; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    #lists details { margin-bottom:8px; border:1px solid #ddd; border-radius:6px; padding:4px; background:#fafafa; }
    .list-item { display:flex; align-items:center; justify-content:space-between; padding:6px; border-bottom:1px solid #eee; cursor:pointer; }
    .list-item:hover { background:#f0f0f0; }
    .item-name { flex:1; margin:0 8px; display:flex; align-items:center; gap:6px; }
    .item-dist { color:gray; font-size:0.9em; }
    .cat-count { font-weight:bold; color:#333; }

    /* Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„ÙØ¦Ø§Øª */
    .icon { width:20px; height:20px; display:inline-block; text-align:center; font-size:16px; }

    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
    #controls {
      position:absolute; top:-60px; right:0;
      display:flex; gap:10px; flex-wrap:wrap; z-index:1000;
    }
    #controls button, #controls select {
      padding:8px 16px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; font-size:14px; transition:0.3s;
    }
    #speech-toggle { background-color:#28a745; color:#fff; }
    #speech-toggle:hover { background-color:#218838; }
    #voice-btn { background-color:#17a2b8; color:#fff; }
    #voice-btn:hover { background-color:#117a8b; }
    #lang-select { background-color:#ffc107; color:#212529; }
    #lang-select:hover { background-color:#e0a800; }

    /* Ø§Ù„ÙÙˆØªØ± */
    #footer-wrapper { margin-top:30px; }
    #footer { text-align:right; font-size:14px; padding:20px 0; }
  </style>
</head>
<body class="is-preload homepage">

  <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
  <div id="intro-screen">
    <img src="loading-image.png" alt="Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„" />
    <p style="font-size:18px;">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
  </div>

  <div id="page-wrapper">
    <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
    <div id="header-wrapper">
      <header id="header" class="container" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
        <div id="logo" style="order:1;">
          <a href="index.html">
            <img src="loading-image.png" alt="Ø§Ù„Ø´Ø¹Ø§Ø±" style="max-width:150px; height:auto;" />
          </a>
        </div>

        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ†Ù‚Ù„ -->
        <nav style="order:2; display:flex; align-items:center;">
          <ul style="display:flex; gap:20px; list-style:none; margin:0; padding:0; align-items:center; position:relative;">
            <li style="display:flex; align-items:center;">
              <a href="index.html" style="font-weight:bold; text-decoration:none; color:#444; padding:8px 16px; border-radius:8px;">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            </li>
            <li style="display:flex; align-items:center;">
              <a href="future work.html" style="font-weight:bold; text-decoration:none; color:#444; padding:8px 16px; border-radius:8px;">Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©</a>
            </li>
            <li style="display:flex; align-items:center;">
              <a href="card.html" style="font-weight:bold; text-decoration:none; color:#444; padding:8px 16px; border-radius:8px;">Ø¨Ø·Ø§Ù‚Ø© Ù…Ø´ÙƒØ§Ø©</a>
            </li>

            <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ØºØ© -->
            <li style="position:relative;">
              <button onclick="toggleLanguageMenu()" style="background:none; border:none; font-size:24px; cursor:pointer; padding:8px;" title="ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©">ğŸŒ</button>
              <ul id="language-menu" style="display:none; position:absolute; top:40px; left:0; background:#fff; border:1px solid #ddd; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1); list-style:none; padding:10px 0; margin:0; min-width:160px; z-index:1000;">
                <li><a href="index.html" style="display:flex; align-items:center; padding:8px 16px; color:#444; font-weight:bold;">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</a></li>
              </ul>
            </li>
          </ul>
        </nav>
      </header>
    </div>

<script>
function toggleLanguageMenu(){
  const menu = document.getElementById("language-menu");
  menu.style.display = (menu.style.display === "block") ? "none" : "block";
}
document.addEventListener('click', function(event){
  const menu = document.getElementById("language-menu");
  const button = menu.previousElementSibling;
  if(!menu.contains(event.target) && !button.contains(event.target)){
    menu.style.display = "none";
  }
});
</script>

  <!-- Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© -->
  <div class="container-map">
    <div id="controls">
      <button id="speech-toggle">ØªÙØ¹ÙŠÙ„ ÙˆØµÙ Ø§Ù„Ù…Ø³Ø§Ø±</button>
      <button id="voice-btn">Ø§Ù„ØªØ­Ø¯Ø«</button>
      <select id="lang-select">
        <option value="ar-SA" selected>Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
      </select>
    </div>

    <div id="map"></div>
    <div id="lists"></div>
  </div>

<!-- Ø§Ù„ÙÙˆØªØ± -->
<div id="footer-wrapper">
  <footer id="footer" class="container">
    <div class="row" style="margin-bottom:15px;">
      <div class="col-3 col-6-medium col-12-small">
        <section class="widget contact last">
          <h3>ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</h3>
          <ul style="list-style:none; padding:0; margin:0;">
            <li><a href="#" class="icon brands fa-twitter" style="text-decoration:none; color:#444;">ØªÙˆÙŠØªØ±</a></li>
            <li><a href="#" class="icon brands fa-facebook-f" style="text-decoration:none; color:#444;">ÙÙŠØ³Ø¨ÙˆÙƒ</a></li>
            <li><a href="#" class="icon brands fa-instagram" style="text-decoration:none; color:#444;">Ø¥Ù†Ø³ØªØºØ±Ø§Ù…</a></li>
          </ul>
          <p style="margin-top:10px;">1234 Ø´Ø§Ø±Ø¹ Ø®ÙŠØ§Ù„ÙŠ<br />
          Ø§Ù„Ø±ÙŠØ§Ø¶ØŒ Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©<br />
          800-555-0000</p>
        </section>
      </div>
    </div>

    <div class="row">
      <div class="col-12">
        <div id="copyright">
          <ul style="list-style:none; padding:0; margin:0;">
            <li>&copy; Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</li>
            <li>ØªØµÙ…ÙŠÙ…: <a href="http://html5up.net" style="text-decoration:none; color:#444;">HTML5 UP</a></li>
          </ul>
        </div>
      </div>
    </div>
  </footer>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
const categories = {
  "Ù…Ø·Ø§Ø¹Ù…": {filter:'amenity=restaurant', icon:'ğŸ´'},
  "ÙÙ†Ø§Ø¯Ù‚": {filter:'tourism=hotel', icon:'ğŸ¨'},
  "Ø£Ø¬Ù‡Ø²Ø© ØµØ±Ø§Ù Ø¢Ù„ÙŠ": {filter:'amenity=atm', icon:'ğŸ§'},
  "ØµÙŠØ¯Ù„ÙŠØ§Øª": {filter:'amenity=pharmacy', icon:'ğŸ’Š'},
  "Ù…Ø³ØªØ´ÙÙŠØ§Øª": {filter:'amenity=hospital', icon:'ğŸ¥'},
  "Ù…ØªØ§Ø¬Ø±": {filter:'shop=*', icon:'ğŸ›ï¸'},
  "Ù…Ù‚Ø§Ù‡ÙŠ": {filter:'amenity=cafe', icon:'â˜•'},
  "Ø¯ÙˆØ±Ø§Øª Ù…ÙŠØ§Ù‡": {filter:'amenity=toilets', icon:'ğŸš»'}
};

let userLocation = [21.4225,39.8262];
let speechEnabled = true;
let lang = "ar-SA";

document.getElementById("speech-toggle").addEventListener("click", () => {
  speechEnabled = !speechEnabled;
  document.getElementById("speech-toggle").innerText = speechEnabled ? "ØªÙØ¹ÙŠÙ„ ÙˆØµÙ Ø§Ù„Ù…Ø³Ø§Ø±" : "Ø¥ÙŠÙ‚Ø§Ù ÙˆØµÙ Ø§Ù„Ù…Ø³Ø§Ø±";
});

const map = L.map('map').setView(userLocation, 16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap contributors' }).addTo(map);

let userMarker = L.marker(userLocation).addTo(map).bindPopup("Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ").openPopup();
let routingControl = null;
let allPlaces = [];

navigator.geolocation.getCurrentPosition(pos => {
  userLocation = [pos.coords.latitude, pos.coords.longitude];
  userMarker.setLatLng(userLocation).bindPopup("Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ");
}, ()=>{});

function loadPlaces(lat, lon){
  const listsDiv = document.getElementById("lists");
  listsDiv.innerHTML = "";
  allPlaces = [];
  for(const [name, cat] of Object.entries(categories)){
    const overpassUrl = `https://overpass-api.de/api/interpreter?data=[out:json];node[${cat.filter}](around:1500,${lat},${lon});out;`;
    fetch(overpassUrl)
      .then(res=>res.json())
      .then(data=>{
        let html = `<details open><summary>${cat.icon} ${name} (<span class="cat-count">${data.elements.length}</span>)</summary>`;
        data.elements.forEach((el,index)=>{
          const placeLat = el.lat;
          const placeLon = el.lon;
          let placeName = el.tags.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";
          if(name==="Ø£Ø¬Ù‡Ø²Ø© ØµØ±Ø§Ù Ø¢Ù„ÙŠ"){
            const atmNames = ["Ù…ØµØ±Ù Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ 1","Ù…ØµØ±Ù Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ 2","Ù…ØµØ±Ù Ø§Ù„Ø£Ù‡Ù„ÙŠ 1","Ù…ØµØ±Ù Ø§Ù„Ø£Ù‡Ù„ÙŠ 2","Ø³Ø§Ù…Ø¨Ø§ 1","Ø³Ø§Ù…Ø¨Ø§ 2","Ø§Ù„Ø±ÙŠØ§Ø¶ 1","Ø§Ù„Ø±ÙŠØ§Ø¶ 2","Ø§Ù„Ø¬Ø²ÙŠØ±Ø©","Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡"];
            placeName = atmNames[index % atmNames.length];
          }
          allPlaces.push({name:placeName,lat:placeLat,lon:placeLon});
          const dist = calcDistance(userLocation[0],userLocation[1],placeLat,placeLon).toFixed(2);
          L.marker([placeLat, placeLon]).addTo(map).bindPopup(`${placeName}<br>${dist} ÙƒÙ…`);
          html += `<div class="list-item" onclick="focusPlace(${placeLat},${placeLon},'${placeName}')"><span class="item-name"><span class="icon">${cat.icon}</span>${placeName}</span><span class="item-dist">${dist} ÙƒÙ…</span></div>`;
        });
        html += "</details>";
        listsDiv.innerHTML += html;
      });
  }
}

function focusPlace(lat, lon, name){
  map.setView([lat, lon],18);
  L.popup().setLatLng([lat,lon]).setContent(name).openOn(map);
  speak(name);

  if(!speechEnabled) return;

  if(routingControl) map.removeControl(routingControl);
  routingControl = L.Routing.control({
    waypoints:[L.latLng(userLocation[0],userLocation[1]),L.latLng(lat,lon)],
    lineOptions:{styles:[{color:'blue',opacity:0.6,weight:5}]},
    addWaypoints:false,
    draggableWaypoints:false,
    routeWhileDragging:false,
    showAlternatives:false,
    createMarker:()=>null
  }).addTo(map);

  describeRoute(userLocation,[lat,lon],name);
}

function describeRoute(start,end,placeName){
  const latDiff=end[0]-start[0];
  const lonDiff=end[1]-start[1];
  let text=`Ø§ØªØ¬Ù‡ Ù…Ù† Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù„Ù‰ ${placeName}. `;
  text+=Math.abs(latDiff)>Math.abs(lonDiff)?(latDiff>0?"ØªØ­Ø±Ùƒ Ø´Ù…Ø§Ù„Ø§Ù‹. ":"ØªØ­Ø±Ùƒ Ø¬Ù†ÙˆØ¨Ø§Ù‹. "):(lonDiff>0?"ØªØ­Ø±Ùƒ Ø´Ø±Ù‚Ø§Ù‹. ":"ØªØ­Ø±Ùƒ ØºØ±Ø¨Ø§Ù‹. ");
  speak(text);
}

function speak(text){
  const utterance=new SpeechSynthesisUtterance(text);
  utterance.lang=lang;
  speechSynthesis.speak(utterance);
}

function calcDistance(lat1,lon1,lat2,lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition.lang = lang;
recognition.continuous = false;
recognition.interimResults = false;

document.getElementById("voice-btn").addEventListener("click", ()=>{ recognition.lang = lang; recognition.start(); });

recognition.onresult = function(event){
  const speech = event.results[0][0].transcript.toLowerCase();
  let found = allPlaces.find(p => p.name.toLowerCase().includes(speech));
  if(found){ focusPlace(found.lat, found.lon,found.name); } else { speak("Ø§Ù„Ù…ÙƒØ§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"); }
}

loadPlaces(userLocation[0],userLocation[1]);
window.onload = ()=>{ document.getElementById('intro-screen').style.display='none'; };
</script>

<script src="assets/js/jquery.min.js"></script>
<script src="assets/js/jquery.dropotron.min.js"></script>
<script src="assets/js/browser.min.js"></script>
<script src="assets/js/breakpoints.min.js"></script>
<script src="assets/js/util.js"></script>
<script src="assets/js/main.js"></script>
</body>
</html>
