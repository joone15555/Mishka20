<!DOCTYPE HTML>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ù„Ù„Ø­Ø¬Ø§Ø¬</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
    .container { max-width: 1200px; margin: 0 auto; display: flex; gap: 20px; }
    #map { width: 70%; height: 600px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    #sidebar { width: 30%; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-height: 600px; overflow-y: auto; }
    .controls { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
    button { padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
    #voice-btn { background: #007bff; color: white; }
    #info-btn { background: #28a745; color: white; }
    .category { margin-bottom: 15px; }
    .category-title { background: #6c757d; color: white; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; }
    .place-item { padding: 8px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; cursor: pointer; border-left: 4px solid #007bff; }
    .place-item:hover { background: #e9ecef; }
    .place-name { font-weight: bold; }
    .place-distance { color: #666; font-size: 14px; }
    .close { color: #28a745; }
    .far { color: #dc3545; }
    #route-details { background: #e8f5e8; padding: 15px; border-radius: 8px; margin-top: 15px; display: none; }
    #search-box { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; }
  </style>
</head>
<body>

<div class="controls">
  <button id="voice-btn">ğŸ¤ Ø¨Ø­Ø« ØµÙˆØªÙŠ</button>
  <button id="info-btn">â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>
</div>

<div class="container">
  <div id="map"></div>
  <div id="sidebar">
    <input type="text" id="search-box" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù†...">
    <div id="places-list"></div>
    <div id="route-details">
      <h4>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø±</h4>
      <div id="route-content"></div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
const categories = {
  "Ù…Ø·Ø§Ø¹Ù…": {filter:'amenity=restaurant', icon:'ğŸ´'},
  "ÙÙ†Ø§Ø¯Ù‚": {filter:'tourism=hotel', icon:'ğŸ¨'},
  "Ø£Ø¬Ù‡Ø²Ø© ØµØ±Ø§Ù": {filter:'amenity=atm', icon:'ğŸ§'},
  "ØµÙŠØ¯Ù„ÙŠØ§Øª": {filter:'amenity=pharmacy', icon:'ğŸ’Š'},
  "Ù…Ø³ØªØ´ÙÙŠØ§Øª": {filter:'amenity=hospital', icon:'ğŸ¥'},
  "Ù…ØªØ§Ø¬Ø±": {filter:'shop=*', icon:'ğŸ›ï¸'},
  "Ù…Ù‚Ø§Ù‡ÙŠ": {filter:'amenity=cafe', icon:'â˜•'},
  "Ø¯ÙˆØ±Ø§Øª Ù…ÙŠØ§Ù‡": {filter:'amenity=toilets', icon:'ğŸš»'}
};

let userLocation = [21.4225, 39.8262];
let map = L.map('map').setView(userLocation, 16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let userMarker = L.marker(userLocation).addTo(map).bindPopup("Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ");
let routingControl = null;
let allPlaces = [];

// ØªØªØ¨Ø¹ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
if (navigator.geolocation) {
  navigator.geolocation.watchPosition(pos => {
    userLocation = [pos.coords.latitude, pos.coords.longitude];
    userMarker.setLatLng(userLocation);
    map.panTo(userLocation);
  });
}

function loadPlaces() {
  const placesList = document.getElementById('places-list');
  placesList.innerHTML = '';
  allPlaces = [];
  
  Object.entries(categories).forEach(([categoryName, categoryData]) => {
    const url = `https://overpass-api.de/api/interpreter?data=[out:json];node[${categoryData.filter}](around:3000,${userLocation[0]},${userLocation[1]});out;`;
    
    fetch(url)
      .then(res => res.json())
      .then(data => {
        if (data.elements.length === 0) return;
        
        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ù…Ø§ÙƒÙ† Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
        const places = data.elements.map(el => {
          const distance = calcDistance(userLocation[0], userLocation[1], el.lat, el.lon);
          return {
            name: el.tags.name || `${categoryName} Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…`,
            lat: el.lat,
            lon: el.lon,
            distance: distance,
            category: categoryName
          };
        }).sort((a, b) => a.distance - b.distance);
        
        allPlaces.push(...places);
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø³Ù… Ø§Ù„ÙØ¦Ø©
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'category';
        categoryDiv.innerHTML = `
          <div class="category-title">${categoryData.icon} ${categoryName} (${places.length})</div>
          <div class="category-places" style="display: block;">
            ${places.map(place => {
              const distanceText = place.distance < 1 ? 'Ù‚Ø±ÙŠØ¨' : 'Ø¨Ø¹ÙŠØ¯';
              const distanceClass = place.distance < 1 ? 'close' : 'far';
              
              // Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
              L.marker([place.lat, place.lon])
                .addTo(map)
                .bindPopup(`${place.name}<br>${place.distance.toFixed(2)} ÙƒÙ…`);
              
              return `
                <div class="place-item" onclick="showRoute(${place.lat}, ${place.lon}, '${place.name}')">
                  <div class="place-name">${place.name}</div>
                  <div class="place-distance ${distanceClass}">
                    ${place.distance.toFixed(2)} ÙƒÙ… - ${distanceText}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
        
        placesList.appendChild(categoryDiv);
        
        // Ø¬Ø¹Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù†Ù‚Ø± Ù„Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ù…Ø§ÙƒÙ†
        categoryDiv.querySelector('.category-title').onclick = function() {
          const placesDiv = categoryDiv.querySelector('.category-places');
          placesDiv.style.display = placesDiv.style.display === 'none' ? 'block' : 'none';
        };
      });
  });
}

function showRoute(lat, lon, placeName) {
  map.setView([lat, lon], 18);
  
  if (routingControl) {
    map.removeControl(routingControl);
  }
  
  routingControl = L.Routing.control({
    waypoints: [
      L.latLng(userLocation[0], userLocation[1]),
      L.latLng(lat, lon)
    ],
    lineOptions: {
      styles: [{ color: '#007bff', weight: 5, opacity: 0.8 }]
    },
    addWaypoints: false,
    draggableWaypoints: false,
    createMarker: () => null
  }).addTo(map);
  
  showRouteDetails(lat, lon, placeName);
}

function showRouteDetails(lat, lon, placeName) {
  const distance = calcDistance(userLocation[0], userLocation[1], lat, lon);
  const walkingTime = Math.ceil(distance * 12); // 12 Ø¯Ù‚ÙŠÙ‚Ø© Ù„ÙƒÙ„ ÙƒÙŠÙ„ÙˆÙ…ØªØ±
  
  // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§ØªØ¬Ø§Ù‡
  const latDiff = lat - userLocation[0];
  const lonDiff = lon - userLocation[1];
  
  let direction = '';
  let landmarks = '';
  
  if (Math.abs(latDiff) > Math.abs(lonDiff)) {
    if (latDiff > 0) {
      direction = 'Ø´Ù…Ø§Ù„Ø§Ù‹';
      landmarks = 'Ø¨Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ÙƒØ¹Ø¨Ø© Ø§Ù„Ù…Ø´Ø±ÙØ©';
    } else {
      direction = 'Ø¬Ù†ÙˆØ¨Ø§Ù‹';
      landmarks = 'Ø¨Ø¹ÙŠØ¯Ø§Ù‹ Ø¹Ù† Ø§Ù„ÙƒØ¹Ø¨Ø© Ø§Ù„Ù…Ø´Ø±ÙØ©';
    }
  } else {
    if (lonDiff > 0) {
      direction = 'Ø´Ø±Ù‚Ø§Ù‹';
      landmarks = 'Ø¨Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØµÙØ§ ÙˆØ§Ù„Ù…Ø±ÙˆØ©';
    } else {
      direction = 'ØºØ±Ø¨Ø§Ù‹';
      landmarks = 'Ø¨Ø¹ÙŠØ¯Ø§Ù‹ Ø¹Ù† Ø§Ù„ØµÙØ§ ÙˆØ§Ù„Ù…Ø±ÙˆØ©';
    }
  }
  
  const routeContent = `
    <strong>Ø§Ù„ÙˆØ¬Ù‡Ø©:</strong> ${placeName}<br>
    <strong>Ø§Ù„Ù…Ø³Ø§ÙØ©:</strong> ${distance.toFixed(2)} ÙƒÙ…<br>
    <strong>ÙˆÙ‚Øª Ø§Ù„Ù…Ø´ÙŠ:</strong> ${walkingTime} Ø¯Ù‚ÙŠÙ‚Ø©<br>
    <strong>Ø§Ù„Ø§ØªØ¬Ø§Ù‡:</strong> ${direction} ${landmarks}<br><br>
    
    <strong>ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø±:</strong><br>
    1. Ø§Ø¨Ø¯Ø£ Ù…Ù† Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ<br>
    2. Ø§ØªØ¬Ù‡ ${direction} ${landmarks}<br>
    3. Ø§ØªØ¨Ø¹ Ø§Ù„Ø®Ø· Ø§Ù„Ø£Ø²Ø±Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©<br>
    4. Ø³ØªØµÙ„ Ø¥Ù„Ù‰ ${placeName} Ø®Ù„Ø§Ù„ ${walkingTime} Ø¯Ù‚ÙŠÙ‚Ø© ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹<br><br>
    
    <em>Ù†ØµÙŠØ­Ø©: Ø§Ø³ØªØ®Ø¯Ù… ${landmarks} ÙƒÙ†Ù‚Ø·Ø© Ù…Ø±Ø¬Ø¹ÙŠØ© Ù„Ù„ØªÙˆØ¬Ù‡</em>
  `;
  
  document.getElementById('route-content').innerHTML = routeContent;
  document.getElementById('route-details').style.display = 'block';
  
  // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª ØµÙˆØªÙŠØ§Ù‹
  const speechText = `Ø§Ù„ÙˆØ¬Ù‡Ø© ${placeName}. Ø§Ù„Ù…Ø³Ø§ÙØ© ${distance.toFixed(2)} ÙƒÙŠÙ„ÙˆÙ…ØªØ±. Ø§ØªØ¬Ù‡ ${direction} ${landmarks}. ÙˆÙ‚Øª Ø§Ù„Ù…Ø´ÙŠ ${walkingTime} Ø¯Ù‚ÙŠÙ‚Ø©.`;
  speak(speechText);
}

function calcDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) + 
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function speak(text) {
  if ('speechSynthesis' in window) {
    speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'ar-SA';
    utterance.rate = 0.8;
    speechSynthesis.speak(utterance);
  }
}

// Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØµÙˆØªÙŠ
document.getElementById('voice-btn').onclick = function() {
  if ('webkitSpeechRecognition' in window) {
    const recognition = new webkitSpeechRecognition();
    recognition.lang = 'ar-SA';
    recognition.start();
    
    recognition.onresult = function(event) {
      const searchTerm = event.results[0][0].transcript;
      document.getElementById('search-box').value = searchTerm;
      filterPlaces();
    };
  } else {
    alert('Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØµÙˆØªÙŠ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­');
  }
};

// Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ
document.getElementById('search-box').oninput = filterPlaces;

function filterPlaces() {
  const searchTerm = document.getElementById('search-box').value.toLowerCase();
  const placeItems = document.querySelectorAll('.place-item');
  
  placeItems.forEach(item => {
    const placeName = item.querySelector('.place-name').textContent.toLowerCase();
    if (placeName.includes(searchTerm)) {
      item.style.display = 'block';
    } else {
      item.style.display = 'none';
    }
  });
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù…Ø§ÙƒÙ† Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
window.onload = function() {
  loadPlaces();
};
</script>

</body>
</html>
