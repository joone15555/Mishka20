<!DOCTYPE HTML>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ù„Ù„Ø­Ø¬Ø§Ø¬ - ØªÙˆØ¬ÙŠÙ‡ ØµÙˆØªÙŠ</title>
  <link rel="stylesheet" href="assets/css/main.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <style>
    /* Ø¯Ù…Ø¬ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù…Ø¹ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
    .container-map { display: flex; flex-direction: column; max-width: 1200px; margin: 30px auto; gap: 20px; padding: 0 20px; position: relative; }
    #map { width: 100%; height: 600px; border-radius: 16px; box-shadow: 0 4px 25px rgba(0,0,0,0.15); }
    #lists { background: linear-gradient(145deg, #c6c6d0, #a7957c); color: #333; padding: 15px; border-radius: 20px; max-height: 600px; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.25); font-family: "Cairo", sans-serif; transition: 0.3s; }
    #lists details { margin-bottom: 14px; border-radius: 14px; overflow: hidden; background: rgba(255,255,255,0.15); box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: all 0.3s; border-left: 5px solid #a7957c; }
    #lists summary { font-weight: bold; font-size: 17px; padding: 12px 16px; background: linear-gradient(to right, #a7957c, #c6c6d0); color: #fff; cursor: pointer; outline: none; border-radius: 12px; }
    .list-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-radius: 12px; margin: 4px 0; background: rgba(255,255,255,0.2); transition: background 0.3s, transform 0.2s; cursor: pointer; }
    .list-item:hover { background: rgba(255,255,255,0.3); transform: translateX(5px); }
    .item-name { flex: 1; margin: 0 8px; display: flex; align-items: center; gap: 10px; font-size: 15px; color: #333; }
    .item-dist { color: #444; font-size: 13px; background: rgba(255,255,255,0.25); padding: 3px 8px; border-radius: 10px; font-weight: bold; }
    .icon { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 16px; border-radius: 50%; background: #a7957c; color: white; flex-shrink: 0; }
    .walking-time { font-size: 11px; color: #666; margin-top: 2px; }
    
    #controls { display: flex; flex-direction: row; justify-content: center; gap: 10px; z-index: 1000; margin-bottom: 20px; }
    #controls button { display: flex; align-items: center; gap: 6px; padding: 10px 18px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; }
    #voice-btn { background-color: #17a2b8; color: #fff; }
    #voice-btn:hover { background-color: #117a8b; }
    #navigation-btn { background-color: #28a745; color: #fff; }
    #navigation-btn:hover { background-color: #218838; }
    #stop-nav-btn { background-color: #dc3545; color: #fff; display: none; }
    #stop-nav-btn:hover { background-color: #c82333; }
    #info-btn { background-color: #ffc107; color: #212529; }
    #info-btn:hover { background-color: #e0a800; }
    
    #info-popup { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: white; padding: 16px 22px; border-radius: 16px; box-shadow: 0 6px 25px rgba(0,0,0,0.25); z-index: 1001; display: none; max-width: 320px; font-family: Cairo, sans-serif; transition: 0.3s; }
    #info-popup button { margin-top: 10px; padding: 6px 12px; font-size: 13px; border: none; border-radius: 10px; background: #4facfe; color: white; cursor: pointer; }
    
    /* Ø¥Ø¶Ø§ÙØ© ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„ØµÙˆØªÙŠ */
    #voice-navigation { 
      position: fixed; 
      bottom: 20px; 
      right: 20px; 
      background: linear-gradient(135deg, #28a745, #20c997); 
      color: white; 
      padding: 20px 25px; 
      border-radius: 15px; 
      box-shadow: 0 8px 30px rgba(40, 167, 69, 0.4); 
      z-index: 1002; 
      display: none; 
      text-align: center; 
      min-width: 280px;
      max-width: 320px;
    }
    #voice-navigation.active { 
      display: block; 
      animation: pulseBottomRight 2s infinite; 
    }
    
    @keyframes pulseBottomRight {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .distance-indicator { background: rgba(255,255,255,0.9); color: #28a745; padding: 8px 15px; border-radius: 25px; font-weight: bold; margin-top: 15px; }
    
    #search-box { width: 100%; padding: 10px 12px; margin-bottom: 10px; border-radius: 12px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; }
    
    .services-bar {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto 10px;
      background: linear-gradient(145deg, #c6c6d0, #a7957c);
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      overflow: hidden;
      padding: 8px 0;
      box-sizing: border-box;
    }
    
    .services-scroll {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding: 0 12px;
      scrollbar-width: none;
    }
    
    .services-scroll::-webkit-scrollbar { display: none; }
    
    .service-item {
      flex: 0 0 auto;
      background: rgba(255,255,255,0.15);
      border-radius: 12px;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
    }
    
    .service-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      background: rgba(255,255,255,0.25);
    }
    
    .service-item.active {
      background: rgba(255,255,255,0.4);
      border-color: #a7957c;
      transform: translateY(-2px);
    }
    
    .service-item img {
      width: 28px;
      height: 28px;
    }
    
    .service-text {
      font-weight: bold;
      font-size: 13px;
      white-space: nowrap;
      color: #333;
    }
  </style>
</head>
<body class="is-preload homepage">

<!-- Ø¥Ø¶Ø§ÙØ© Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
<div id="intro-screen" style="position: fixed; top:0; left:0; width:100%; height:100%; background:#ffffff; color:#000; display:flex; justify-content:center; align-items:center; flex-direction:column; font-family:sans-serif; z-index:9999;">
  <img src="loading-image.png" alt="ØªØ­Ù…ÙŠÙ„" style="margin-bottom:20px; max-width:200px;">
  <p style="font-size:18px;">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ø¬Ø§Ø¬...</p>
</div>

<!-- Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø£ØµÙ„ÙŠ -->
<div id="header-wrapper">
  <header id="header" class="container" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; direction: rtl;">
    <div id="logo" style="order: 1;">
      <a href="index.html">
        <img src="loading-image.png" alt="Ø´Ø¹Ø§Ø±" style="max-width:150px; height:auto;">
      </a>
    </div>
    <nav style="order: 2; display: flex; align-items: center;">
      <ul style="display:flex; gap:20px; list-style:none; margin:0; padding:0; align-items:center; position:relative;">
        <li><a href="index.html" style="font-weight:bold; text-decoration:none; color:#444; padding:8px 16px; border-radius:8px; transition:0.3s;"
          onmouseover="this.style.backgroundColor='#f0f0f0'; this.style.color='#000';"
          onmouseout="this.style.backgroundColor='transparent'; this.style.color='#444';"
        >Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
        <li><a href="card.html" style="font-weight:bold; text-decoration:none; color:#444; padding:8px 16px; border-radius:8px; transition:0.3s;"
          onmouseover="this.style.backgroundColor='#f0f0f0'; this.style.color='#000';"
          onmouseout="this.style.backgroundColor='transparent'; this.style.color='#444';"
        >Ø¨Ø·Ø§Ù‚Ø© Ù…Ø´ÙƒØ§Ø©</a></li>

        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„ØºØ§Øª -->
        <li style="position: relative;">
          <button onclick="toggleLanguageMenu()" style="background:none; border:none; font-size:24px; cursor:pointer; padding:8px;" title="ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©">ğŸŒ</button>
          <ul id="language-menu" style="display:none; position:absolute; top:40px; left:0; background-color:#fff; border:1px solid #ddd; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1); list-style:none; padding:10px 0; margin:0; min-width:160px; z-index:1000;">
            <li><a href="map1.html" style="display:flex; align-items:center; padding:8px 16px; text-decoration:none; color:#444; font-weight:bold; transition: background 0.3s;" onmouseover="this.style.backgroundColor='#f0f0f0';" onmouseout="this.style.backgroundColor='transparent';">ğŸ‡¸ğŸ‡¦ &nbsp; Ø¹Ø±Ø¨ÙŠ</a></li>
            <li><a href="map1_en.html" style="display:flex; align-items:center; padding:8px 16px; text-decoration:none; color:#444; font-weight:bold; transition: background 0.3s;" onmouseover="this.style.backgroundColor='#f0f0f0';" onmouseout="this.style.backgroundColor='transparent';">ğŸ‡ºğŸ‡¸ &nbsp; English</a></li>
            <li><a href="map1_es 2.html" style="display:flex; align-items:center; padding:8px 16px; text-decoration:none; color:#444; font-weight:bold; transition: background 0.3s;" onmouseover="this.style.backgroundColor='#f0f0f0';" onmouseout="this.style.backgroundColor='transparent';">ğŸ‡µğŸ‡° &nbsp; Ø§Ø±Ø¯Ùˆ</a></li>
          </ul>
        </li>
      </ul>
    </nav>
  </header>
</div>

<!-- Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙŠØ· Ø§Ù„Ø®Ø¯Ù…Ø§Øª ÙÙˆÙ‚ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ø¨Ø§Ø´Ø±Ø© -->
<div class="services-bar">
  <div class="services-scroll">
    <div class="service-item active" onclick="selectService('all')"><img src="11.png" alt="Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª"><span class="service-text">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</span></div>
    <div class="service-item" onclick="selectService('Ù…Ù‚Ø§Ù‡ÙŠ')"><img src="11.png" alt="Ù…Ù‚Ù‡Ù‰"><span class="service-text">Ø§Ù„Ù…Ù‚Ø§Ù‡ÙŠ</span></div>
    <div class="service-item" onclick="selectService('Ø£Ø¬Ù‡Ø²Ø© ØµØ±Ø§Ù')"><img src="8.png" alt="ØµØ±Ø§Ù Ø¢Ù„ÙŠ"><span class="service-text">ØµØ±Ø§Ù Ø¢Ù„ÙŠ</span></div>
    <div class="service-item" onclick="selectService('Ø¯ÙˆØ±Ø§Øª Ù…ÙŠØ§Ù‡')"><img src="17.png" alt="Ø¯ÙˆØ±Ø§Øª Ù…ÙŠØ§Ù‡"><span class="service-text">Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…ÙŠØ§Ù‡</span></div>
    <div class="service-item" onclick="selectService('Ù…Ø·Ø§Ø¹Ù…')"><img src="13.png" alt="Ù…Ø·Ø¹Ù…"><span class="service-text">Ø§Ù„Ù…Ø·Ø§Ø¹Ù…</span></div>
    <div class="service-item" onclick="selectService('ØµÙŠØ¯Ù„ÙŠØ§Øª')"><img src="7.png" alt="ØµÙŠØ¯Ù„ÙŠØ©"><span class="service-text">Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª</span></div>
    <div class="service-item" onclick="selectService('ÙÙ†Ø§Ø¯Ù‚')"><img src="12.png" alt="ÙÙ†Ø¯Ù‚"><span class="service-text">Ø§Ù„ÙÙ†Ø§Ø¯Ù‚</span></div>
    <div class="service-item" onclick="selectService('Ù…ØªØ§Ø¬Ø±')"><img src="16.png" alt="Ø³ÙˆÙ‚"><span class="service-text">Ø§Ù„Ù…ØªØ§Ø¬Ø±</span></div>
    <div class="service-item" onclick="selectService('Ù…Ø³ØªØ´ÙÙŠØ§Øª')"><img src="15.png" alt="Ù…Ø³ØªØ´ÙÙ‰"><span class="service-text">Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª</span></div>
  </div>
</div>

<!-- Ø¥Ø¶Ø§ÙØ© Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„ØµÙˆØªÙŠ -->
<div id="voice-navigation">
  <div id="nav-instruction" style="font-size: 16px; font-weight: bold;">Ø¬Ø§Ø±ÙŠ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡...</div>
  <div id="nav-distance" class="distance-indicator">Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: -- Ù…ØªØ±</div>
</div>

<!-- Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰ -->
<div class="container-map">
  <div id="map"></div>
  <div id="controls">
    <button id="voice-btn">ğŸ¤ Ø¨Ø­Ø« ØµÙˆØªÙŠ</button>
    <button id="navigation-btn">ğŸ§­ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡</button>
    <button id="stop-nav-btn">â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙˆØ¬ÙŠÙ‡</button>
    <button id="info-btn">â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>
  </div>
  <div id="lists">
    <input type="text" id="search-box" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ Ø§Ù„Ø®Ø¯Ù…Ø§Øª..." oninput="filterList()">
  </div>
  <div id="info-popup">
    <strong id="info-title"></strong>
    <p id="info-desc" style="margin-top: 8px; font-size: 14px;"></p>
    <button onclick="document.getElementById('info-popup').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
</div>

<!-- Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙˆØªØ± Ø§Ù„Ø£ØµÙ„ÙŠ -->
<div id="footer-wrapper">
  <footer id="footer" class="container">
    <div class="row">
      <div class="col-3 col-6-medium col-12-small">
        <section class="widget contact last">
          <h3>ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</h3>
          <ul>
            <li><a href="#" class="icon brands fa-twitter"><span class="label">ØªÙˆÙŠØªØ±</span></a></li>
            <li><a href="#" class="icon brands fa-facebook-f"><span class="label">ÙÙŠØ³Ø¨ÙˆÙƒ</span></a></li>
            <li><a href="#" class="icon brands fa-instagram"><span class="label">Ø§Ù†Ø³ØªØºØ±Ø§Ù…</span></a></li>
            <li><a href="#" class="icon brands fa-dribbble"><span class="label">Ø¯Ø±ÙŠØ¨Ù„</span></a></li>
            <li><a href="#" class="icon brands fa-pinterest"><span class="label">Ø¨ÙŠÙ†ØªØ±Ø³Øª</span></a></li>
          </ul>
          <p>Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©<br />
          Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©<br />
          (800) 555-0000</p>
        </section>
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <div id="copyright">
          <ul class="menu">
            <li>&copy; Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</li><li>Ø§Ù„ØªØµÙ…ÙŠÙ…: <a href="http://html5up.net">HTML5 UP</a></li>
          </ul>
        </div>
      </div>
    </div>
  </footer>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>

<script>
const categories = {
  "Ù…Ø·Ø§Ø¹Ù…": {filter:'amenity=restaurant', icon:'ğŸ´', color:'#ff6b6b'},
  "ÙÙ†Ø§Ø¯Ù‚": {filter:'tourism=hotel', icon:'ğŸ¨', color:'#4834d4'},
  "Ø£Ø¬Ù‡Ø²Ø© ØµØ±Ø§Ù": {filter:'amenity=atm', icon:'ğŸ§', color:'#00d2d3'},
  "ØµÙŠØ¯Ù„ÙŠØ§Øª": {filter:'amenity=pharmacy', icon:'ğŸ’Š', color:'#ff9ff3'},
  "Ù…Ø³ØªØ´ÙÙŠØ§Øª": {filter:'amenity=hospital', icon:'ğŸ¥', color:'#ff3838'},
  "Ù…ØªØ§Ø¬Ø±": {filter:'shop=*', icon:'ğŸ›ï¸', color:'#ffb142'},
  "Ù…Ù‚Ø§Ù‡ÙŠ": {filter:'amenity=cafe', icon:'â˜•', color:'#8c7ae6'},
  "Ø¯ÙˆØ±Ø§Øª Ù…ÙŠØ§Ù‡": {filter:'amenity=toilets', icon:'ğŸš»', color:'#00d2d3'}
};

const categoryDescriptions = {
  "Ù…Ø·Ø§Ø¹Ù…": "Ù…Ø·Ø§Ø¹Ù…: ØªÙ‚Ø¯Ù… Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ØªÙ†ÙˆØ¹Ø© Ù…Ù† Ø§Ù„Ø£Ø·Ø¹Ù…Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙˆØ§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©.",
  "ÙÙ†Ø§Ø¯Ù‚": "ÙÙ†Ø§Ø¯Ù‚: Ø¥Ù‚Ø§Ù…Ø© Ù…Ø±ÙŠØ­Ø© Ù…Ø¹ Ø®Ø¯Ù…Ø§Øª Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¬ÙˆØ¯Ø©.",
  "Ø£Ø¬Ù‡Ø²Ø© ØµØ±Ø§Ù": "Ø£Ø¬Ù‡Ø²Ø© ØµØ±Ø§Ù: Ø³Ø­Ø¨ ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ù…ÙˆØ§Ù„ Ø¨Ø³Ù‡ÙˆÙ„Ø©.",
  "ØµÙŠØ¯Ù„ÙŠØ§Øª": "ØµÙŠØ¯Ù„ÙŠØ§Øª: Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØµØ­ÙŠØ©.",
  "Ù…Ø³ØªØ´ÙÙŠØ§Øª": "Ù…Ø³ØªØ´ÙÙŠØ§Øª: Ø®Ø¯Ù…Ø§Øª Ø·Ø¨ÙŠØ© Ø·Ø§Ø±Ø¦Ø© ÙˆÙ…Ø³ØªØ¯Ø§Ù…Ø©.",
  "Ù…ØªØ§Ø¬Ø±": "Ù…ØªØ§Ø¬Ø±: Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ØªÙ†ÙˆØ¹Ø© Ù…Ù† Ø§Ù„Ù…Ù„Ø§Ø¨Ø³ ÙˆØ§Ù„Ø¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª.",
  "Ù…Ù‚Ø§Ù‡ÙŠ": "Ù…Ù‚Ø§Ù‡ÙŠ: Ù…ÙƒØ§Ù† Ù„Ù„Ø§Ø³ØªØ±Ø®Ø§Ø­ ÙˆØ§Ù„Ø§Ø³ØªÙ…ØªØ§Ø¹ Ø¨Ø§Ù„Ù‚Ù‡ÙˆØ©.",
  "Ø¯ÙˆØ±Ø§Øª Ù…ÙŠØ§Ù‡": "Ø¯ÙˆØ±Ø§Øª Ù…ÙŠØ§Ù‡: Ù…ØªØ§Ø­Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø§Ù….",
  "Unknown": "Ø§Ù„ÙˆØµÙ ØºÙŠØ± Ù…ØªÙˆÙØ±."
};

let userLocation = [21.4225, 39.8262];
let lang = "ar-SA";
let lastSelectedPlace = null;
const map = L.map('map').setView(userLocation, 16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap contributors' }).addTo(map);

const userIcon = L.divIcon({
  className: 'user-location-marker',
  html: `<div style="
    width: 20px; 
    height: 20px; 
    background: linear-gradient(45deg, #007bff, #0056b3); 
    border: 3px solid white; 
    border-radius: 50%; 
    box-shadow: 0 0 10px rgba(0,123,255,0.5);
    animation: userPulse 2s infinite;
  "></div>
  <style>
    @keyframes userPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
  </style>`,
  iconSize: [20, 20],
  iconAnchor: [10, 10]
});

let userMarker = L.marker(userLocation, {icon: userIcon}).addTo(map).bindPopup("Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ");
let routingControl = null;
let allPlaces = [];
let fuse = null;
let currentDestination = null;
let isNavigating = false;
let lastInstruction = '';
let watchId = null;
let selectedService = 'all';
let allMarkers = [];

function createCategoryIcon(categoryData) {
  return L.divIcon({
    className: 'category-marker',
    html: `<div style="
      width: 30px; 
      height: 30px; 
      background: ${categoryData.color}; 
      border: 2px solid white; 
      border-radius: 50%; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    ">${categoryData.icon}</div>`,
    iconSize: [30, 30],
    iconAnchor: [15, 15]
  });
}

// ØªØªØ¨Ø¹ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
if (navigator.geolocation) {
  navigator.geolocation.watchPosition(pos => {
    const newLocation = [pos.coords.latitude, pos.coords.longitude];
    userLocation = newLocation;
    userMarker.setLatLng(newLocation);
    map.panTo(newLocation);
    
    if (isNavigating && currentDestination) {
      updateVoiceNavigation(newLocation);
    }
  }, err => console.log(err), {enableHighAccuracy: true, maximumAge: 1000});
}

function updateVoiceNavigation(currentPos) {
  if (!currentDestination) return;
  
  const distanceToDestination = calcDistance(
    currentPos[0], currentPos[1], 
    currentDestination.lat, currentDestination.lon
  ) * 1000;
  
  document.getElementById('nav-distance').textContent = 
    `Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: ${Math.round(distanceToDestination)} Ù…ØªØ±`;
  
  let instruction = '';
  
  if (distanceToDestination < 10) {
    instruction = `ÙˆØµÙ„Øª Ø¥Ù„Ù‰ ${currentDestination.name}`;
    stopNavigation();
    speak(instruction);
    return;
  } else if (distanceToDestination < 50) {
    instruction = `Ø§Ù‚ØªØ±Ø¨Øª Ù…Ù† ${currentDestination.name}ØŒ Ø§Ù„Ù…Ø³Ø§ÙØ© ${Math.round(distanceToDestination)} Ù…ØªØ±`;
  } else if (distanceToDestination < 100) {
    instruction = `Ø§Ø³ØªÙ…Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ØŒ Ø§Ù„Ù…Ø³Ø§ÙØ© ${Math.round(distanceToDestination)} Ù…ØªØ±`;
  } else if (distanceToDestination < 200) {
    const direction = getDirection(currentPos, [currentDestination.lat, currentDestination.lon]);
    instruction = `Ø§ØªØ¬Ù‡ ${direction}ØŒ Ø§Ù„Ù…Ø³Ø§ÙØ© ${Math.round(distanceToDestination)} Ù…ØªØ±`;
  }
  
  if (instruction && instruction !== lastInstruction) {
    document.getElementById('nav-instruction').textContent = instruction;
    speak(instruction);
    lastInstruction = instruction;
  }
}

function getDirection(from, to) {
  const latDiff = to[0] - from[0];
  const lonDiff = to[1] - from[1];
  
  if (Math.abs(latDiff) > Math.abs(lonDiff)) {
    return latDiff > 0 ? 'Ø´Ù…Ø§Ù„Ø§Ù‹' : 'Ø¬Ù†ÙˆØ¨Ø§Ù‹';
  } else {
    return lonDiff > 0 ? 'Ø´Ø±Ù‚Ø§Ù‹' : 'ØºØ±Ø¨Ø§Ù‹';
  }
}

function loadPlaces(lat, lon) {
  const listsDiv = document.getElementById("lists");
  const searchHTML = listsDiv.querySelector("#search-box").outerHTML;
  listsDiv.innerHTML = searchHTML;
  allPlaces = [];
  
  // Ù…Ø³Ø­ Ø§Ù„Ù…Ø§Ø±ÙƒØ±Ø² Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
  allMarkers.forEach(marker => map.removeLayer(marker));
  allMarkers = [];
  
  for(const [name, cat] of Object.entries(categories)) {
    const overpassUrl = `https://overpass-api.de/api/interpreter?data=[out:json];node[${cat.filter}](around:2000,${lat},${lon});out;`;
    fetch(overpassUrl)
      .then(res => res.json())
      .then(data => {
        const placesWithDistance = data.elements.map((el, index) => {
          const placeLat = el.lat;
          const placeLon = el.lon;
          let placeName = el.tags.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";
          
          if(name === "Ø£Ø¬Ù‡Ø²Ø© ØµØ±Ø§Ù") {
            const atmNames = ["ØµØ±Ø§Ù Ø§Ù„Ø£Ù‡Ù„ÙŠ", "ØµØ±Ø§Ù Ø³Ø§Ù…Ø¨Ø§", "ØµØ±Ø§Ù Ø§Ù„Ø±ÙŠØ§Ø¶", "ØµØ±Ø§Ù Ø§Ù„Ø¬Ø²ÙŠØ±Ø©"];
            placeName = atmNames[index % atmNames.length];
          }
          
          const dist = calcDistance(userLocation[0], userLocation[1], placeLat, placeLon);
          return {
            name: placeName,
            lat: placeLat,
            lon: placeLon,
            category: name,
            distance: dist
          };
        }).sort((a, b) => a.distance - b.distance).slice(0, 8);
        
        // Ø¥Ù†Ø´Ø§Ø¡ HTML Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
        let html = `<details open data-category="${name}"><summary>${cat.icon} ${name} (<span class="cat-count">${placesWithDistance.length}</span>)</summary>`;
        
        placesWithDistance.forEach(place => {
          allPlaces.push(place);
          const distKm = place.distance.toFixed(2);
          const walkingTimeMinutes = Math.ceil(place.distance * 12);
          
          // Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø±ÙƒØ± Ù…Ø®ØµØµ Ù„Ù„Ø®Ø±ÙŠØ·Ø©
          const marker = L.marker([place.lat, place.lon], {
            icon: createCategoryIcon(cat)
          }).addTo(map);
          
          marker.bindPopup(`${place.name}<br>${distKm} ÙƒÙ… - ${walkingTimeMinutes} Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ø´ÙŠ`);
          marker.category = name; // Ø¥Ø¶Ø§ÙØ© Ø®Ø§ØµÙŠØ© Ø§Ù„ÙØ¦Ø© Ù„Ù„Ù…Ø§Ø±ÙƒØ±
          allMarkers.push(marker);
          
          html += `<div class="list-item" data-category="${name}" onclick="selectDestination(${place.lat},${place.lon},'${place.name.replace(/'/g, "&#39;")}')">
            <span class="item-name">
              <span class="icon">${cat.icon}</span>
              <div>
                ${place.name}
                <div class="walking-time">ğŸš¶â€â™‚ï¸ ${walkingTimeMinutes} Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ø´ÙŠ</div>
              </div>
            </span>
            <span class="item-dist">${distKm} ÙƒÙ…</span>
          </div>`;
        });
        
        html += "</details>";
        listsDiv.innerHTML += html;
        fuse = new Fuse(allPlaces, {keys:["name"], threshold:0.4});
        
        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        if (selectedService !== 'all') {
          filterByService(selectedService);
        }
      });
  }
}

function selectDestination(lat, lon, name) {
  currentDestination = { lat, lon, name };
  map.setView([lat, lon], 18);
  L.popup().setLatLng([lat, lon]).setContent(name).openOn(map);
  lastSelectedPlace = {name, lat, lon, category: name};
  
  if(routingControl) map.removeControl(routingControl);
  
  routingControl = L.Routing.control({
    waypoints: [L.latLng(userLocation[0], userLocation[1]), L.latLng(lat, lon)],
    router: L.Routing.osrmv1({
      serviceUrl: 'https://router.project-osrm.org/route/v1',
      profile: 'foot'
    }),
    lineOptions: {
      styles: [{ color: '#28a745', weight: 6, opacity: 0.8 }]
    },
    addWaypoints: false,
    draggableWaypoints: false,
    createMarker: () => null,
    show: false
  }).addTo(map);
  
  speak(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ${name} ÙƒÙˆØ¬Ù‡Ø©. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø±Ø´Ø§Ø¯Ø§Øª ØµÙˆØªÙŠØ© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´ÙŠ.`);
}

function startNavigation() {
  if (!currentDestination) {
    alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙˆØ¬Ù‡Ø© Ø£ÙˆÙ„Ø§Ù‹');
    return;
  }
  
  isNavigating = true;
  document.getElementById('voice-navigation').classList.add('active');
  document.getElementById('navigation-btn').style.display = 'none';
  document.getElementById('stop-nav-btn').style.display = 'inline-flex';
  
  const initialDistance = calcDistance(
    userLocation[0], userLocation[1], 
    currentDestination.lat, currentDestination.lon
  ) * 1000;
  
  document.getElementById('nav-instruction').textContent = 
    `Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ${currentDestination.name}`;
  document.getElementById('nav-distance').textContent = 
    `Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: ${Math.round(initialDistance)} Ù…ØªØ±`;
  
  speak(`Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ${currentDestination.name}. Ø§ØªØ¨Ø¹ Ø§Ù„Ø®Ø· Ø§Ù„Ø£Ø®Ø¶Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.`);
}

function stopNavigation() {
  isNavigating = false;
  document.getElementById('voice-navigation').classList.remove('active');
  document.getElementById('navigation-btn').style.display = 'inline-flex';
  document.getElementById('stop-nav-btn').style.display = 'none';
  
  lastInstruction = '';
  speak('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„ØµÙˆØªÙŠ');
}

function speak(text) {
  speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = lang;
  utterance.rate = 0.9;
  speechSynthesis.speak(utterance);
}

function calcDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) + 
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function filterList() {
  const query = document.getElementById("search-box").value.toLowerCase();
  document.querySelectorAll(".list-item").forEach(item => {
    const name = item.querySelector(".item-name").innerText.toLowerCase();
    item.style.display = name.includes(query) ? "flex" : "none";
  });
}

// Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØµÙˆØªÙŠ
document.getElementById("voice-btn").addEventListener("click", () => {
  if(!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
    alert("Ù…ÙŠØ²Ø© Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù…ØªØµÙØ­Ùƒ");
    return;
  }
  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = lang;
  recognition.start();
  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript;
    if(fuse) {
      const results = fuse.search(transcript);
      if(results.length > 0) {
        const match = results[0].item;
        selectDestination(match.lat, match.lon, match.name);
      } else {
        speak("Ø§Ù„Ù…ÙƒØ§Ù† ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
      }
    }
  }
});

document.getElementById("info-btn").addEventListener("click", () => {
  const popup = document.getElementById("info-popup");
  if(lastSelectedPlace) {
    document.getElementById("info-title").innerText = lastSelectedPlace.name;
    document.getElementById("info-desc").innerText = categoryDescriptions[lastSelectedPlace.category] || categoryDescriptions["Unknown"];
    popup.style.display = "block";
  } else {
    alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙƒØ§Ù† Ø£ÙˆÙ„Ø§Ù‹");
  }
});

document.getElementById('navigation-btn').onclick = startNavigation;
document.getElementById('stop-nav-btn').onclick = stopNavigation;

function toggleLanguageMenu() {
  const menu = document.getElementById('language-menu');
  if (menu.style.display === 'block') { 
    menu.style.display = 'none'; 
  } else { 
    menu.style.display = 'block'; 
  }
}

document.addEventListener('click', function (e) {
  const menu = document.getElementById('language-menu');
  const button = e.target.closest('button');
  if (!e.target.closest('#language-menu') && (!button || button.innerText !== 'ğŸŒ')) {
    menu.style.display = 'none';
  }
});

function selectService(serviceName) {
  selectedService = serviceName;
  
  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
  document.querySelectorAll('.service-item').forEach(item => {
    item.classList.remove('active');
  });
  event.target.closest('.service-item').classList.add('active');
  
  if (serviceName === 'all') {
    // Ø¥Ø¸Ù‡Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª
    document.querySelectorAll('#lists details').forEach(detail => {
      detail.style.display = 'block';
    });
    document.querySelectorAll('.list-item').forEach(item => {
      item.style.display = 'flex';
    });
    allMarkers.forEach(marker => {
      marker.addTo(map);
    });
  } else {
    // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
    filterByService(serviceName);
  }
}

function filterByService(serviceName) {
  // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
  document.querySelectorAll('#lists details').forEach(detail => {
    const category = detail.getAttribute('data-category');
    if (category === serviceName) {
      detail.style.display = 'block';
      detail.setAttribute('open', 'true');
    } else {
      detail.style.display = 'none';
    }
  });
  
  // Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  document.querySelectorAll('.list-item').forEach(item => {
    const category = item.getAttribute('data-category');
    if (category === serviceName) {
      item.style.display = 'flex';
    } else {
      item.style.display = 'none';
    }
  });
  
  // Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø§Ø±ÙƒØ±Ø² Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
  allMarkers.forEach(marker => {
    if (marker.category === serviceName) {
      marker.addTo(map);
    } else {
      map.removeLayer(marker);
    }
  });
}

window.addEventListener("load", () => {
  setTimeout(() => {document.getElementById("intro-screen").style.display="none";}, 1500);
  loadPlaces(userLocation[0], userLocation[1]);
});
</script>
</body>
</html>

