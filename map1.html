<!DOCTYPE HTML>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ù„Ù„Ø­Ø¬Ø§Ø¬ - ØªÙˆØ¬ÙŠÙ‡ ØµÙˆØªÙŠ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <style>
    /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© */
    .container-map { display: flex; flex-direction: column; max-width: 1200px; margin: 30px auto; gap: 20px; padding: 0 20px; position: relative; }
    #map { width: 100%; height: 600px; border-radius: 16px; box-shadow: 0 4px 25px rgba(0,0,0,0.15); }
    #lists { background: linear-gradient(145deg, #c6c6d0, #a7957c); color: #333; padding: 15px; border-radius: 20px; max-height: 600px; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.25); font-family: "Cairo", sans-serif; transition: 0.3s; }
    #lists details { margin-bottom: 14px; border-radius: 14px; overflow: hidden; background: rgba(255,255,255,0.15); box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: all 0.3s; border-left: 5px solid #a7957c; }
    #lists summary { font-weight: bold; font-size: 17px; padding: 12px 16px; background: linear-gradient(to right, #a7957c, #c6c6d0); color: #fff; cursor: pointer; outline: none; border-radius: 12px; }
    .list-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-radius: 12px; margin: 4px 0; background: rgba(255,255,255,0.2); transition: background 0.3s, transform 0.2s; cursor: pointer; }
    .list-item:hover { background: rgba(255,255,255,0.3); transform: translateX(5px); }
    .item-name { flex: 1; margin: 0 8px; display: flex; align-items: center; gap: 10px; font-size: 15px; color: #333; }
    .item-dist { color: #444; font-size: 13px; background: rgba(255,255,255,0.25); padding: 3px 8px; border-radius: 10px; font-weight: bold; }
    .icon { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 16px; border-radius: 50%; background: #a7957c; color: white; flex-shrink: 0; }
    .walking-time { font-size: 11px; color: #666; margin-top: 2px; }
    
    #controls { display: flex; flex-direction: row; justify-content: center; gap: 10px; z-index: 1000; margin-bottom: 20px; }
    #controls button { display: flex; align-items: center; gap: 6px; padding: 10px 18px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; }
    #voice-btn { background-color: #17a2b8; color: #fff; }
    #voice-btn:hover { background-color: #117a8b; }
    #navigation-btn { background-color: #28a745; color: #fff; }
    #navigation-btn:hover { background-color: #218838; }
    #stop-nav-btn { background-color: #dc3545; color: #fff; display: none; }
    #stop-nav-btn:hover { background-color: #c82333; }
    
    #search-box { width: 100%; padding: 10px; margin-bottom: 12px; border-radius: 12px; border: none; font-size: 14px; }
    
    /* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„ØµÙˆØªÙŠ */
    #voice-navigation { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #28a745; color: white; padding: 15px 25px; border-radius: 15px; box-shadow: 0 6px 25px rgba(0,0,0,0.3); z-index: 1002; display: none; max-width: 400px; text-align: center; }
    #voice-navigation.active { display: block; animation: pulse 2s infinite; }
    
    @keyframes pulse {
      0% { box-shadow: 0 6px 25px rgba(40, 167, 69, 0.3); }
      50% { box-shadow: 0 6px 35px rgba(40, 167, 69, 0.6); }
      100% { box-shadow: 0 6px 25px rgba(40, 167, 69, 0.3); }
    }
    
    .distance-indicator { background: #fff; color: #28a745; padding: 5px 10px; border-radius: 20px; font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„ØµÙˆØªÙŠ -->
<div id="voice-navigation">
  <div id="nav-instruction">Ø¬Ø§Ø±ÙŠ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡...</div>
  <div id="nav-distance" class="distance-indicator">Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: -- Ù…ØªØ±</div>
</div>

<div class="container-map">
  <div id="controls">
    <button id="voice-btn">ğŸ¤ Ø¨Ø­Ø« ØµÙˆØªÙŠ</button>
    <button id="navigation-btn">ğŸ§­ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡</button>
    <button id="stop-nav-btn">â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙˆØ¬ÙŠÙ‡</button>
  </div>
  
  <div id="map"></div>
  
  <div id="lists">
    <input type="text" id="search-box" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ Ø§Ù„Ø®Ø¯Ù…Ø§Øª..." oninput="filterList()">
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
const categories = {
  "Ù…Ø·Ø§Ø¹Ù…": {filter:'amenity=restaurant', icon:'ğŸ´'},
  "ÙÙ†Ø§Ø¯Ù‚": {filter:'tourism=hotel', icon:'ğŸ¨'},
  "Ø£Ø¬Ù‡Ø²Ø© ØµØ±Ø§Ù": {filter:'amenity=atm', icon:'ğŸ§'},
  "ØµÙŠØ¯Ù„ÙŠØ§Øª": {filter:'amenity=pharmacy', icon:'ğŸ’Š'},
  "Ù…Ø³ØªØ´ÙÙŠØ§Øª": {filter:'amenity=hospital', icon:'ğŸ¥'},
  "Ù…ØªØ§Ø¬Ø±": {filter:'shop=*', icon:'ğŸ›ï¸'},
  "Ù…Ù‚Ø§Ù‡ÙŠ": {filter:'amenity=cafe', icon:'â˜•'},
  "Ø¯ÙˆØ±Ø§Øª Ù…ÙŠØ§Ù‡": {filter:'amenity=toilets', icon:'ğŸš»'}
};

let userLocation = [21.4225, 39.8262];
let map = L.map('map').setView(userLocation, 16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let userMarker = L.marker(userLocation).addTo(map).bindPopup("Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ");
let routingControl = null;
let allPlaces = [];
let currentDestination = null;
let isNavigating = false;
let lastInstruction = '';
let watchId = null;

// ØªØªØ¨Ø¹ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„ØµÙˆØªÙŠ
function startLocationTracking() {
  if (navigator.geolocation) {
    watchId = navigator.geolocation.watchPosition(
      position => {
        const newLocation = [position.coords.latitude, position.coords.longitude];
        userLocation = newLocation;
        userMarker.setLatLng(newLocation);
        
        if (isNavigating && currentDestination) {
          updateVoiceNavigation(newLocation);
        }
      },
      error => console.log('Ø®Ø·Ø£ ÙÙŠ ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹:', error),
      { enableHighAccuracy: true, maximumAge: 1000, timeout: 5000 }
    );
  }
}

function updateVoiceNavigation(currentPos) {
  if (!currentDestination) return;
  
  const distanceToDestination = calcDistance(
    currentPos[0], currentPos[1], 
    currentDestination.lat, currentDestination.lon
  ) * 1000; // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ù…ØªØ±
  
  document.getElementById('nav-distance').textContent = 
    `Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: ${Math.round(distanceToDestination)} Ù…ØªØ±`;
  
  // Ø¥Ø¹Ø·Ø§Ø¡ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
  let instruction = '';
  
  if (distanceToDestination < 10) {
    instruction = `ÙˆØµÙ„Øª Ø¥Ù„Ù‰ ${currentDestination.name}`;
    stopNavigation();
    speak(instruction);
    return;
  } else if (distanceToDestination < 50) {
    instruction = `Ø§Ù‚ØªØ±Ø¨Øª Ù…Ù† ${currentDestination.name}ØŒ Ø§Ù„Ù…Ø³Ø§ÙØ© ${Math.round(distanceToDestination)} Ù…ØªØ±`;
  } else if (distanceToDestination < 100) {
    instruction = `Ø§Ø³ØªÙ…Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ØŒ Ø§Ù„Ù…Ø³Ø§ÙØ© ${Math.round(distanceToDestination)} Ù…ØªØ±`;
  } else if (distanceToDestination < 200) {
    const direction = getDirection(currentPos, [currentDestination.lat, currentDestination.lon]);
    instruction = `Ø§ØªØ¬Ù‡ ${direction}ØŒ Ø§Ù„Ù…Ø³Ø§ÙØ© ${Math.round(distanceToDestination)} Ù…ØªØ±`;
  }
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ© Ø£Ùˆ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± ÙƒØ¨ÙŠØ± ÙÙŠ Ø§Ù„Ù…Ø³Ø§ÙØ©
  if (instruction && instruction !== lastInstruction) {
    document.getElementById('nav-instruction').textContent = instruction;
    speak(instruction);
    lastInstruction = instruction;
  }
}

function getDirection(from, to) {
  const latDiff = to[0] - from[0];
  const lonDiff = to[1] - from[1];
  
  if (Math.abs(latDiff) > Math.abs(lonDiff)) {
    return latDiff > 0 ? 'Ø´Ù…Ø§Ù„Ø§Ù‹' : 'Ø¬Ù†ÙˆØ¨Ø§Ù‹';
  } else {
    return lonDiff > 0 ? 'Ø´Ø±Ù‚Ø§Ù‹' : 'ØºØ±Ø¨Ø§Ù‹';
  }
}

function loadPlaces() {
  const listsDiv = document.getElementById("lists");
  const searchHTML = listsDiv.querySelector("#search-box").outerHTML;
  listsDiv.innerHTML = searchHTML;
  allPlaces = [];
  
  for(const [name, cat] of Object.entries(categories)){
    const overpassUrl = `https://overpass-api.de/api/interpreter?data=[out:json];node[${cat.filter}](around:2000,${userLocation[0]},${userLocation[1]});out;`;
    
    fetch(overpassUrl)
      .then(res=>res.json())
      .then(data=>{
        const placesWithDistance = data.elements.map((el, index) => {
          const placeLat = el.lat;
          const placeLon = el.lon;
          let placeName = el.tags.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";
          
          if(name==="Ø£Ø¬Ù‡Ø²Ø© ØµØ±Ø§Ù"){
            const atmNames = ["ØµØ±Ø§Ù Ø§Ù„Ø£Ù‡Ù„ÙŠ","ØµØ±Ø§Ù Ø³Ø§Ù…Ø¨Ø§","ØµØ±Ø§Ù Ø§Ù„Ø±ÙŠØ§Ø¶","ØµØ±Ø§Ù Ø§Ù„Ø¬Ø²ÙŠØ±Ø©"];
            placeName = atmNames[index % atmNames.length];
          }
          
          const dist = calcDistance(userLocation[0],userLocation[1],placeLat,placeLon);
          return {
            name: placeName,
            lat: placeLat,
            lon: placeLon,
            category: name,
            distance: dist
          };
        }).sort((a, b) => a.distance - b.distance).slice(0, 8); // Ø£Ù‚Ø±Ø¨ 8 Ø£Ù…Ø§ÙƒÙ†
        
        let html = `<details open><summary>${cat.icon} ${name} (${placesWithDistance.length})</summary>`;
        
        placesWithDistance.forEach(place => {
          allPlaces.push(place);
          const distKm = place.distance.toFixed(2);
          const walkingTimeMinutes = Math.ceil(place.distance * 12);
          
          L.marker([place.lat, place.lon]).addTo(map)
            .bindPopup(`${place.name}<br>${distKm} ÙƒÙ… - ${walkingTimeMinutes} Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ø´ÙŠ`);
          
          html += `<div class="list-item" onclick="selectDestination(${place.lat},${place.lon},'${place.name.replace(/'/g, "&#39;")}')">
            <span class="item-name">
              <span class="icon">${cat.icon}</span>
              <div>
                ${place.name}
                <div class="walking-time">ğŸš¶â€â™‚ï¸ ${walkingTimeMinutes} Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ø´ÙŠ</div>
              </div>
            </span>
            <span class="item-dist">${distKm} ÙƒÙ…</span>
          </div>`;
        });
        
        html += "</details>";
        listsDiv.innerHTML += html;
      });
  }
}

function selectDestination(lat, lon, name) {
  currentDestination = { lat, lon, name };
  map.setView([lat, lon], 18);
  
  if (routingControl) map.removeControl(routingControl);
  
  routingControl = L.Routing.control({
    waypoints: [L.latLng(userLocation[0], userLocation[1]), L.latLng(lat, lon)],
    router: L.Routing.osrmv1({
      serviceUrl: 'https://router.project-osrm.org/route/v1',
      profile: 'foot'
    }),
    lineOptions: {
      styles: [{ color: '#28a745', weight: 6, opacity: 0.8 }]
    },
    addWaypoints: false,
    draggableWaypoints: false,
    createMarker: () => null,
    show: false
  }).addTo(map);
  
  speak(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ${name} ÙƒÙˆØ¬Ù‡Ø©. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø±Ø´Ø§Ø¯Ø§Øª ØµÙˆØªÙŠØ© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´ÙŠ.`);
}

function startNavigation() {
  if (!currentDestination) {
    alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙˆØ¬Ù‡Ø© Ø£ÙˆÙ„Ø§Ù‹');
    return;
  }
  
  isNavigating = true;
  document.getElementById('voice-navigation').classList.add('active');
  document.getElementById('navigation-btn').style.display = 'none';
  document.getElementById('stop-nav-btn').style.display = 'inline-flex';
  
  const initialDistance = calcDistance(
    userLocation[0], userLocation[1], 
    currentDestination.lat, currentDestination.lon
  ) * 1000;
  
  document.getElementById('nav-instruction').textContent = 
    `Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ${currentDestination.name}`;
  document.getElementById('nav-distance').textContent = 
    `Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: ${Math.round(initialDistance)} Ù…ØªØ±`;
  
  speak(`Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ${currentDestination.name}. Ø§ØªØ¨Ø¹ Ø§Ù„Ø®Ø· Ø§Ù„Ø£Ø®Ø¶Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.`);
  
  startLocationTracking();
}

function stopNavigation() {
  isNavigating = false;
  document.getElementById('voice-navigation').classList.remove('active');
  document.getElementById('navigation-btn').style.display = 'inline-flex';
  document.getElementById('stop-nav-btn').style.display = 'none';
  
  if (watchId) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }
  
  lastInstruction = '';
  speak('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„ØµÙˆØªÙŠ');
}

function speak(text) {
  if ('speechSynthesis' in window) {
    speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'ar-SA';
    utterance.rate = 0.9;
    speechSynthesis.speak(utterance);
  }
}

function calcDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) + 
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function filterList() {
  const query = document.getElementById("search-box").value.toLowerCase();
  document.querySelectorAll("#lists details").forEach(detail => {
    detail.querySelectorAll(".list-item").forEach(item => {
      if (item.innerText.toLowerCase().includes(query)) {
        item.style.display = "flex";
      } else {
        item.style.display = "none";
      }
    });
  });
}

// Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØµÙˆØªÙŠ
document.getElementById('voice-btn').onclick = function() {
  if ('webkitSpeechRecognition' in window) {
    const recognition = new webkitSpeechRecognition();
    recognition.lang = 'ar-SA';
    recognition.start();
    
    recognition.onresult = function(event) {
      const searchTerm = event.results[0][0].transcript;
      document.getElementById('search-box').value = searchTerm;
      filterList();
    };
  } else {
    alert('Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØµÙˆØªÙŠ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­');
  }
};

document.getElementById('navigation-btn').onclick = startNavigation;
document.getElementById('stop-nav-btn').onclick = stopNavigation;

window.onload = function() {
  loadPlaces();
};
</script>

</body>
</html>
