<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>مشكاة - الخدمات حول الحرم</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<style>
* {margin:0;padding:0;box-sizing:border-box;}
body {font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#e8e2f0 0%,#d4c5e8 100%);min-height:100vh;direction:rtl;}
.container {max-width:600px;margin:0 auto;padding:20px;}
.header {text-align:center;margin-bottom:30px;}
.logo {width:120px;height:120px;margin:0 auto 15px;display:block;}
.services-container {margin-bottom:30px;}
.services-scroll {display:flex;gap:15px;overflow-x:auto;padding:10px 0;scrollbar-width:none;}
.services-scroll::-webkit-scrollbar {display:none;}
.service-item {position: relative;min-width:120px;height:50px;background:#8b5a96;border-radius:25px;display:flex;align-items:center;justify-content:flex-end;padding:0 15px;color:white;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 8px rgba(139,90,150,0.3);}
.service-item:hover {background:#9d6ba8;transform:translateY(-2px);}
.service-item.active {background:#6b4c75;transform:scale(1.05);}
.service-text {font-size:12px;font-weight:500;flex:1;text-align:right;}
.service-item img {position: absolute;left:10px;top:50%;transform:translateY(-50%);width:24px;height:24px;pointer-events:none;}
.map-section {margin-top:20px;background:white;border-radius:20px;padding:20px;box-shadow:0 4px 12px rgba(139,90,150,0.2);}
#map {width:100%;height:450px;border-radius:16px;box-shadow:0 4px 12px rgba(139,90,150,0.2);margin-bottom:10px;}
#lists {background:#f8f5fb;border-radius:16px;padding:20px;max-height:350px;overflow-y:auto;margin-bottom:10px;}
#lists details {margin-bottom:15px;border:1px solid #e0e0e0;border-radius:12px;overflow:hidden;}
#lists summary {padding:15px;background:#8b5a96;color:white;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:10px;min-height:44px;}
.list-item {display:flex;align-items:center;justify-content:space-between;padding:15px;border-bottom:1px solid #f0f0f0;cursor:pointer;transition:background 0.3s ease;min-height:44px;background:white;}
.list-item:hover {background:#f8f5fb;}
.list-item:last-child {border-bottom:none;}
.item-name {display:flex;align-items:center;gap:10px;flex:1;}
.item-dist {color:#666;font-size:14px;font-weight:500;}
.icon {font-size:18px;width:24px;text-align:center;}
.cat-count {background:#c4b5d4;color:#5a4a6b;padding:4px 8px;border-radius:20px;font-size:12px;font-weight:bold;}
.voice-btn {display:block;width:100%;padding:12px 0;background:#8b5a96;color:white;border:none;border-radius:25px;font-size:16px;cursor:pointer;margin-top:10px;box-shadow:0 4px 8px rgba(139,90,150,0.3);transition:all 0.3s ease;}
.voice-btn:hover {background:#9d6ba8;}
.leaflet-popup-content-wrapper {padding:4px 8px !important;}
.leaflet-popup-content {font-size:12px !important;}
.leaflet-popup-tip {background:#fff !important;}
</style>
</head>
<body>
<div class="container">
    <div class="header"><img src="LOGO2.png" alt="مشكاة" class="logo"></div>
    <div class="services-container">
        <div class="services-scroll">
            <div class="service-item" onclick="toggleService('المقاهي')"><span class="service-text">المقاهي</span><img src="11.png" alt="مقهى"></div>
            <div class="service-item" onclick="toggleService('المطاعم')"><span class="service-text">المطاعم</span><img src="13.png" alt="مطعم"></div>
            <div class="service-item" onclick="toggleService('صرافات')"><span class="service-text">صراف آلي</span><img src="8.png" alt="صراف"></div>
            <div class="service-item" onclick="toggleService('صيدليات')"><span class="service-text">الصيدليات</span><img src="7.png" alt="صيدلية"></div>
            <div class="service-item" onclick="toggleService('مستشفيات')"><span class="service-text">مستشفى</span><img src="15.png" alt="مستشفى"></div>
            <div class="service-item" onclick="toggleService('دورات المياه')"><span class="service-text">دورات المياه</span><img src="17.png" alt="دورات مياه"></div>
            <div class="service-item" onclick="toggleService('سوق')"><span class="service-text">سوق</span><img src="16.png" alt="تسوق"></div>
            <div class="service-item" onclick="toggleService('اتصالات')"><span class="service-text">اتصالات</span><img src="10.png" alt="اتصالات"></div>
        </div>
    </div>
   <div class="map-section">
    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
        <!-- زر التحدث -->
        <button class="voice-btn" id="voice-btn">🎤 التحدث</button>

        <!-- زر اختيار اللغة -->
        <div style="position:relative;">
            <button id="language-btn" style="
                padding:12px 20px;
                border:none;
                border-radius:25px;
                background:#8b5a96;
                color:white;
                font-size:16px;
                cursor:pointer;
                box-shadow:0 4px 8px rgba(139,90,150,0.3);
                transition:all 0.3s ease;
            ">🌐 اللغة</button>
            <ul id="language-menu" style="
                display:none;
                position:absolute;
                top:50px;
                right:0;
                background:white;
                border:1px solid #ddd;
                border-radius:12px;
                list-style:none;
                padding:10px 0;
                margin:0;
                min-width:140px;
                z-index:1000;
            ">
                <li><a href="index.html" style="display:flex; align-items:center; padding:8px 16px; text-decoration:none; color:#444; font-weight:bold; transition:background 0.3s;" onmouseover="this.style.backgroundColor='#f0f0f0';" onmouseout="this.style.backgroundColor='transparent';">🇸🇦 العربية</a></li>
                <li><a href="index_en.html" style="display:flex; align-items:center; padding:8px 16px; text-decoration:none; color:#444; font-weight:bold; transition:background 0.3s;" onmouseover="this.style.backgroundColor='#f0f0f0';" onmouseout="this.style.backgroundColor='transparent';">🇺🇸 English</a></li>
                <li><a href="index_es 2.html" style="display:flex; align-items:center; padding:8px 16px; text-decoration:none; color:#444; font-weight:bold; transition:background 0.3s;" onmouseover="this.style.backgroundColor='#f0f0f0';" onmouseout="this.style.backgroundColor='transparent';">🇵🇰 اردو</a></li>
            </ul>
        </div>

        <!-- زر العودة للصفحة الرئيسية -->
        <a href="index.html" style="
            padding:12px 20px;
            border:none;
            border-radius:25px;
            background:#8b5a96;
            color:white;
            font-size:16px;
            text-decoration:none;
            display:flex;
            align-items:center;
            justify-content:center;
            box-shadow:0 4px 8px rgba(139,90,150,0.3);
            transition:all 0.3s ease;
            cursor:pointer;
        ">🏠 الرئيسية</a>
    </div>

    <div id="map"></div>
    <div id="lists"></div>
</div>

<script>
    // التعامل مع زر اللغة
    const languageBtn = document.getElementById('language-btn');
    const languageMenu = document.getElementById('language-menu');

    languageBtn.addEventListener('click', () => {
        languageMenu.style.display = (languageMenu.style.display === 'block') ? 'none' : 'block';
    });

    // إغلاق القائمة عند الضغط خارجها
    document.addEventListener('click', (e) => {
        if(!languageBtn.contains(e.target) && !languageMenu.contains(e.target)){
            languageMenu.style.display = 'none';
        }
    });
</script>


</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<script>
const categories = {
    "المطاعم": {filter:'amenity=restaurant', icon:'🍽️'},
    "صرافات": {filter:'amenity=atm', icon:'🏧'},
    "صيدليات": {filter:'amenity=pharmacy', icon:'💊'},
    "مستشفيات": {filter:'amenity=hospital', icon:'🏥'},
    "المقاهي": {filter:'amenity=cafe', icon:'☕'},
    "دورات المياه": {filter:'amenity=toilets', icon:'🚻'},
    "سوق": {filter:'shop=supermarket', icon:'🛒'},
    "اتصالات": {filter:'shop=mobile_phone', icon:'📱'}
};

const haramLocation = [21.4225,39.8262];
let map, allMarkers=[], userMarker, routingControl=null;
let userLocation = haramLocation.slice(); 
let lastSelectedPlace = null;

function getIcon(category){
    return L.divIcon({
        html: categories[category]?.icon || '📍',
        className:'',
        iconSize:[30,30],
        popupAnchor:[0,-10]
    });
}

function initMap(){
    map=L.map('map').setView(haramLocation,16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);
    userMarker=L.marker(userLocation).addTo(map).bindPopup("موقعك الحالي").openPopup();

    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
            userLocation=[pos.coords.latitude,pos.coords.longitude];
            userMarker.setLatLng(userLocation).bindPopup("موقعك الحالي").openPopup();
        });
    }

    loadAllCategories();
}

function loadAllCategories(){
    const listsDiv=document.getElementById("lists");
    listsDiv.innerHTML="";
    allMarkers.forEach(m=>map.removeLayer(m));
    allMarkers=[];

    const defaultNames = {}; // لتعداد الأسماء الافتراضية لكل فئة

    for(const [name,cat] of Object.entries(categories)){
        defaultNames[name]=1;

        fetch(`https://overpass-api.de/api/interpreter?data=[out:json];node[${cat.filter}](around:2000,${haramLocation[0]},${haramLocation[1]});out;`)
        .then(r=>r.json()).then(data=>{
            let html=`<details open><summary>${cat.icon} ${name} <span class="cat-count">${data.elements.length}</span></summary>`;
            data.elements.forEach(el=>{
                let placeName=el.tags.name;
                if(!placeName || placeName.trim()===""){
                    placeName=`${name} ${defaultNames[name]}`; // اسم افتراضي
                    defaultNames[name]++;
                }
                const dist=calcDistance(userLocation[0],userLocation[1],el.lat,el.lon).toFixed(2);
                const marker=L.marker([el.lat,el.lon],{icon:getIcon(name)}).addTo(map).bindPopup(`${placeName}<br>${dist} كم`);
                allMarkers.push(marker);
                html+=`<div class="list-item" onclick="focusPlace(${el.lat},${el.lon},'${placeName}','${name}')"><span class="item-name"><span class="icon">${cat.icon}</span>${placeName}</span><span class="item-dist">${dist} كم</span></div>`;
            });
            html+="</details>";
            listsDiv.innerHTML+=html;
        });
    }
}

function toggleService(serviceName){
    const listsDiv=document.getElementById("lists");
    listsDiv.innerHTML="";
    allMarkers.forEach(m=>map.removeLayer(m));
    allMarkers=[];

    const defaultNames = {};
    defaultNames[serviceName]=1;

    for(const [name,cat] of Object.entries(categories)){
        if(name!==serviceName) continue;
        fetch(`https://overpass-api.de/api/interpreter?data=[out:json];node[${cat.filter}](around:2000,${haramLocation[0]},${haramLocation[1]});out;`)
        .then(r=>r.json()).then(data=>{
            let html=`<details open><summary>${cat.icon} ${name} <span class="cat-count">${data.elements.length}</span></summary>`;
            data.elements.forEach(el=>{
                let placeName=el.tags.name;
                if(!placeName || placeName.trim()===""){
                    placeName=`${name} ${defaultNames[name]}`;
                    defaultNames[name]++;
                }
                const dist=calcDistance(userLocation[0],userLocation[1],el.lat,el.lon).toFixed(2);
                const marker=L.marker([el.lat,el.lon],{icon:getIcon(name)}).addTo(map).bindPopup(`${placeName}<br>${dist} كم`);
                allMarkers.push(marker);
                html+=`<div class="list-item" onclick="focusPlace(${el.lat},${el.lon},'${placeName}','${name}')"><span class="item-name"><span class="icon">${cat.icon}</span>${placeName}</span><span class="item-dist">${dist} كم</span></div>`;
            });
            html+="</details>";
            listsDiv.innerHTML=html;
        });
    }
}

function focusPlace(lat,lon,name,category){
    map.setView([lat,lon],18);
    L.popup().setLatLng([lat,lon]).setContent(name).openOn(map);
    lastSelectedPlace={name,lat,lon,category};

    if(routingControl) map.removeControl(routingControl);

    routingControl = L.Routing.control({
        waypoints:[L.latLng(userLocation[0],userLocation[1]),L.latLng(lat,lon)],
        lineOptions:{styles:[{color:'blue',opacity:0.6,weight:5}]},
        addWaypoints:false, draggableWaypoints:false, routeWhileDragging:false, showAlternatives:false,
        createMarker:()=>null
    }).addTo(map);

    describeRoute(userLocation,[lat,lon],name);
}

function describeRoute(start,end,placeName){
    let latDiff=end[0]-start[0];
    let lonDiff=end[1]-start[1];
    let text=`اذهب من موقعك الحالي إلى ${placeName}. `;
    text+=Math.abs(latDiff)>Math.abs(lonDiff)?(latDiff>0?"اتجه شمالًا. ":"اتجه جنوبًا. "):(lonDiff>0?"اتجه شرقًا. ":"اتجه غربًا. ");
    speak(text);
}

function speak(text){ speechSynthesis.cancel(); const utterance=new SpeechSynthesisUtterance(text); utterance.lang="ar-SA"; speechSynthesis.speak(utterance); }

function calcDistance(lat1,lon1,lat2,lon2){
    const R=6371;
    const dLat=(lat2-lat1)*Math.PI/180;
    const dLon=(lon2-lon1)*Math.PI/180;
    const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

// التعرف على الصوت
const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;
let recognition=null;
if(SpeechRecognition){
    recognition=new SpeechRecognition();
    recognition.continuous=false;
    recognition.interimResults=false;
    document.getElementById("voice-btn").addEventListener("click",()=>{
        recognition.lang="ar-SA";
        recognition.start();
    });
    recognition.onresult=function(event){
        const speech=event.results[0][0].transcript.toLowerCase();
        let found = null;
        allMarkers.forEach(m=>{
            if(m.getPopup().getContent().toLowerCase().includes(speech)){
                const latlng = m.getLatLng();
                found = {lat:latlng.lat, lon:latlng.lng, name:m.getPopup().getContent()};
            }
        });
        if(found){
            focusPlace(found.lat,found.lon,found.name.split('<')[0]);
        } else {
            alert("المكان غير موجود في القائمة.");
        }
    };
} else {
    document.getElementById("voice-btn").style.display="none";
}

window.onload=()=>{ initMap(); };
</script>
</body>
</html>
