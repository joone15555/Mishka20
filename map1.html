<!DOCTYPE HTML>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>خريطة الخدمات للحجاج - توجيه صوتي</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: "Cairo", Arial, sans-serif; height: 100vh; overflow: hidden; background: #f0f2f5; }
    
    /* تصميم متجاوب للشاشة الكاملة */
    .main-container { 
      display: grid; 
      grid-template-columns: 1fr 350px; 
      height: 100vh; 
      gap: 0;
    }
    
    @media (max-width: 768px) {
      .main-container { 
        grid-template-columns: 1fr; 
        grid-template-rows: 60vh 1fr;
      }
      #sidebar { 
        order: 2; 
        max-height: 40vh;
      }
    }
    
    #map { 
      width: 100%; 
      height: 100vh; 
      z-index: 1;
    }
    
    #sidebar { 
      background: linear-gradient(145deg, #ffffff, #f8f9fa); 
      padding: 20px; 
      overflow-y: auto; 
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
      border-left: 3px solid #007bff;
    }
    
    /* أزرار التحكم العائمة */
    #controls { 
      position: fixed; 
      top: 20px; 
      right: 20px; 
      display: flex; 
      flex-direction: column; 
      gap: 10px; 
      z-index: 1000; 
    }
    
    #controls button { 
      padding: 12px 16px; 
      border: none; 
      border-radius: 50px; 
      cursor: pointer; 
      font-weight: bold; 
      font-size: 14px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
      transition: all 0.3s;
      min-width: 140px;
    }
    
    #controls button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
    
    #voice-btn { background: linear-gradient(45deg, #17a2b8, #20c997); color: white; }
    #navigation-btn { background: linear-gradient(45deg, #28a745, #20c997); color: white; }
    #stop-nav-btn { background: linear-gradient(45deg, #dc3545, #fd7e14); color: white; display: none; }
    
    /* نافذة التوجيه الصوتي */
    #voice-navigation { 
      position: fixed; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      background: linear-gradient(135deg, #28a745, #20c997); 
      color: white; 
      padding: 25px 35px; 
      border-radius: 20px; 
      box-shadow: 0 10px 40px rgba(40, 167, 69, 0.4); 
      z-index: 1002; 
      display: none; 
      text-align: center;
      min-width: 300px;
    }
    
    #voice-navigation.active { 
      display: block; 
      animation: pulse 2s infinite; 
    }
    
    @keyframes pulse {
      0% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.05); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }
    
    .distance-indicator { 
      background: rgba(255,255,255,0.9); 
      color: #28a745; 
      padding: 8px 15px; 
      border-radius: 25px; 
      font-weight: bold; 
      margin-top: 15px; 
    }
    
    /* تصميم القائمة الجانبية */
    #search-box { 
      width: 100%; 
      padding: 12px 15px; 
      margin-bottom: 20px; 
      border: 2px solid #e9ecef; 
      border-radius: 25px; 
      font-size: 14px; 
      outline: none;
      transition: border-color 0.3s;
    }
    
    #search-box:focus { border-color: #007bff; }
    
    .category { 
      margin-bottom: 20px; 
      border-radius: 15px; 
      overflow: hidden; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .category-title { 
      padding: 15px 20px; 
      font-weight: bold; 
      cursor: pointer; 
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .category-title:hover { transform: translateX(5px); }
    
    .place-item { 
      padding: 12px 20px; 
      margin: 0; 
      background: white; 
      cursor: pointer; 
      transition: all 0.3s;
      border-bottom: 1px solid #f8f9fa;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .place-item:hover { 
      background: #f8f9fa; 
      transform: translateX(10px); 
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .place-item:last-child { border-bottom: none; }
    
    .place-name { font-weight: 600; color: #333; }
    .place-distance { font-size: 12px; color: #666; margin-top: 3px; }
    .distance-badge { 
      background: #007bff; 
      color: white; 
      padding: 4px 8px; 
      border-radius: 12px; 
      font-size: 11px; 
      font-weight: bold;
    }
    
    /* ألوان مختلفة لكل فئة */
    .restaurants { background: linear-gradient(135deg, #ff6b6b, #ee5a24); }
    .hotels { background: linear-gradient(135deg, #4834d4, #686de0); }
    .atms { background: linear-gradient(135deg, #00d2d3, #01a3a4); }
    .pharmacies { background: linear-gradient(135deg, #ff9ff3, #f368e0); }
    .hospitals { background: linear-gradient(135deg, #ff3838, #ff6b6b); }
    .shops { background: linear-gradient(135deg, #ffb142, #ff793f); }
    .cafes { background: linear-gradient(135deg, #8c7ae6, #9c88ff); }
    .toilets { background: linear-gradient(135deg, #00d2d3, #01a3a4); }
  </style>
</head>
<body>

<!-- نافذة التوجيه الصوتي -->
<div id="voice-navigation">
  <div id="nav-instruction" style="font-size: 16px; font-weight: bold;">جاري بدء التوجيه...</div>
  <div id="nav-distance" class="distance-indicator">المسافة المتبقية: -- متر</div>
</div>

<!-- أزرار التحكم العائمة -->
<div id="controls">
  <button id="voice-btn">🎤 بحث صوتي</button>
  <button id="navigation-btn">🧭 بدء التوجيه</button>
  <button id="stop-nav-btn">⏹️ إيقاف التوجيه</button>
</div>

<div class="main-container">
  <div id="map"></div>
  
  <div id="sidebar">
    <input type="text" id="search-box" placeholder="ابحث عن أقرب الخدمات...">
    <div id="places-list"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
const categories = {
  "مطاعم": {
    filter: 'amenity=restaurant', 
    icon: '🍴', 
    color: '#ff6b6b',
    className: 'restaurants'
  },
  "فنادق": {
    filter: 'tourism=hotel', 
    icon: '🏨', 
    color: '#4834d4',
    className: 'hotels'
  },
  "أجهزة صراف": {
    filter: 'amenity=atm', 
    icon: '🏧', 
    color: '#00d2d3',
    className: 'atms'
  },
  "صيدليات": {
    filter: 'amenity=pharmacy', 
    icon: '💊', 
    color: '#ff9ff3',
    className: 'pharmacies'
  },
  "مستشفيات": {
    filter: 'amenity=hospital', 
    icon: '🏥', 
    color: '#ff3838',
    className: 'hospitals'
  },
  "متاجر": {
    filter: 'shop=*', 
    icon: '🛍️', 
    color: '#ffb142',
    className: 'shops'
  },
  "مقاهي": {
    filter: 'amenity=cafe', 
    icon: '☕', 
    color: '#8c7ae6',
    className: 'cafes'
  },
  "دورات مياه": {
    filter: 'amenity=toilets', 
    icon: '🚻', 
    color: '#00d2d3',
    className: 'toilets'
  }
};

let userLocation = [21.4225, 39.8262];
let map = L.map('map').setView(userLocation, 16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// إنشاء أيقونة مميزة للموقع الحالي
const userIcon = L.divIcon({
  className: 'user-location-marker',
  html: `<div style="
    width: 20px; 
    height: 20px; 
    background: linear-gradient(45deg, #007bff, #0056b3); 
    border: 3px solid white; 
    border-radius: 50%; 
    box-shadow: 0 0 10px rgba(0,123,255,0.5);
    animation: userPulse 2s infinite;
  "></div>
  <style>
    @keyframes userPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
  </style>`,
  iconSize: [20, 20],
  iconAnchor: [10, 10]
});

let userMarker = L.marker(userLocation, {icon: userIcon}).addTo(map).bindPopup("📍 موقعك الحالي");
let routingControl = null;
let allPlaces = [];
let currentDestination = null;
let isNavigating = false;
let lastInstruction = '';
let watchId = null;

// إنشاء أيقونات مخصصة لكل فئة
function createCategoryIcon(category, categoryData) {
  return L.divIcon({
    className: 'category-marker',
    html: `<div style="
      width: 30px; 
      height: 30px; 
      background: ${categoryData.color}; 
      border: 2px solid white; 
      border-radius: 50%; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    ">${categoryData.icon}</div>`,
    iconSize: [30, 30],
    iconAnchor: [15, 15]
  });
}

function startLocationTracking() {
  if (navigator.geolocation) {
    watchId = navigator.geolocation.watchPosition(
      position => {
        const newLocation = [position.coords.latitude, position.coords.longitude];
        userLocation = newLocation;
        userMarker.setLatLng(newLocation);
        
        if (isNavigating && currentDestination) {
          updateVoiceNavigation(newLocation);
        }
      },
      error => console.log('خطأ في تتبع الموقع:', error),
      { enableHighAccuracy: true, maximumAge: 1000, timeout: 5000 }
    );
  }
}

function updateVoiceNavigation(currentPos) {
  if (!currentDestination) return;
  
  const distanceToDestination = calcDistance(
    currentPos[0], currentPos[1], 
    currentDestination.lat, currentDestination.lon
  ) * 1000;
  
  document.getElementById('nav-distance').textContent = 
    `المسافة المتبقية: ${Math.round(distanceToDestination)} متر`;
  
  let instruction = '';
  
  if (distanceToDestination < 10) {
    instruction = `وصلت إلى ${currentDestination.name}`;
    stopNavigation();
    speak(instruction);
    return;
  } else if (distanceToDestination < 50) {
    instruction = `اقتربت من ${currentDestination.name}، المسافة ${Math.round(distanceToDestination)} متر`;
  } else if (distanceToDestination < 100) {
    instruction = `استمر في نفس الاتجاه، المسافة ${Math.round(distanceToDestination)} متر`;
  } else if (distanceToDestination < 200) {
    const direction = getDirection(currentPos, [currentDestination.lat, currentDestination.lon]);
    instruction = `اتجه ${direction}، المسافة ${Math.round(distanceToDestination)} متر`;
  }
  
  if (instruction && instruction !== lastInstruction) {
    document.getElementById('nav-instruction').textContent = instruction;
    speak(instruction);
    lastInstruction = instruction;
  }
}

function getDirection(from, to) {
  const latDiff = to[0] - from[0];
  const lonDiff = to[1] - from[1];
  
  if (Math.abs(latDiff) > Math.abs(lonDiff)) {
    return latDiff > 0 ? 'شمالاً' : 'جنوباً';
  } else {
    return lonDiff > 0 ? 'شرقاً' : 'غرباً';
  }
}

function loadPlaces() {
  const placesList = document.getElementById("places-list");
  placesList.innerHTML = '';
  allPlaces = [];
  
  Object.entries(categories).forEach(([categoryName, categoryData]) => {
    const overpassUrl = `https://overpass-api.de/api/interpreter?data=[out:json];node[${categoryData.filter}](around:2000,${userLocation[0]},${userLocation[1]});out;`;
    
    fetch(overpassUrl)
      .then(res => res.json())
      .then(data => {
        if (data.elements.length === 0) return;
        
        const placesWithDistance = data.elements.map((el, index) => {
          const placeLat = el.lat;
          const placeLon = el.lon;
          let placeName = el.tags.name || "بدون اسم";
          
          if (categoryName === "أجهزة صراف") {
            const atmNames = ["صراف الأهلي", "صراف سامبا", "صراف الرياض", "صراف الجزيرة"];
            placeName = atmNames[index % atmNames.length];
          }
          
          const dist = calcDistance(userLocation[0], userLocation[1], placeLat, placeLon);
          return {
            name: placeName,
            lat: placeLat,
            lon: placeLon,
            category: categoryName,
            distance: dist
          };
        }).sort((a, b) => a.distance - b.distance).slice(0, 8);
        
        if (placesWithDistance.length === 0) return;
        
        // إنشاء قسم الفئة
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'category';
        
        const categoryTitle = document.createElement('div');
        categoryTitle.className = `category-title ${categoryData.className}`;
        categoryTitle.innerHTML = `${categoryData.icon} ${categoryName} (${placesWithDistance.length})`;
        categoryDiv.appendChild(categoryTitle);
        
        const placesContainer = document.createElement('div');
        placesContainer.className = 'places-container';
        
        placesWithDistance.forEach(place => {
          allPlaces.push(place);
          const distKm = place.distance.toFixed(2);
          const walkingTimeMinutes = Math.ceil(place.distance * 12);
          
          // إضافة ماركر مخصص للخريطة
          const marker = L.marker([place.lat, place.lon], {
            icon: createCategoryIcon(categoryName, categoryData)
          }).addTo(map);
          
          marker.bindPopup(`
            <div style="text-align: center; font-family: Arial;">
              <strong>${place.name}</strong><br>
              <span style="color: ${categoryData.color};">${categoryData.icon} ${categoryName}</span><br>
              ${distKm} كم - ${walkingTimeMinutes} دقيقة مشي
            </div>
          `);
          
          // إنشاء عنصر المكان في القائمة
          const placeItem = document.createElement('div');
          placeItem.className = 'place-item';
          placeItem.onclick = () => selectDestination(place.lat, place.lon, place.name);
          
          placeItem.innerHTML = `
            <div>
              <div class="place-name">${place.name}</div>
              <div class="place-distance">🚶‍♂️ ${walkingTimeMinutes} دقيقة مشي</div>
            </div>
            <div class="distance-badge">${distKm} كم</div>
          `;
          
          placesContainer.appendChild(placeItem);
        });
        
        categoryDiv.appendChild(placesContainer);
        placesList.appendChild(categoryDiv);
        
        // جعل العنوان قابل للنقر
        categoryTitle.onclick = function() {
          placesContainer.style.display = placesContainer.style.display === 'none' ? 'block' : 'none';
        };
      });
  });
}

function selectDestination(lat, lon, name) {
  currentDestination = { lat, lon, name };
  map.setView([lat, lon], 18);
  
  if (routingControl) map.removeControl(routingControl);
  
  routingControl = L.Routing.control({
    waypoints: [L.latLng(userLocation[0], userLocation[1]), L.latLng(lat, lon)],
    router: L.Routing.osrmv1({
      serviceUrl: 'https://router.project-osrm.org/route/v1',
      profile: 'foot'
    }),
    lineOptions: {
      styles: [{ color: '#007bff', weight: 6, opacity: 0.8 }]
    },
    addWaypoints: false,
    draggableWaypoints: false,
    createMarker: () => null,
    show: false
  }).addTo(map);
  
  speak(`تم اختيار ${name} كوجهة. اضغط على بدء التوجيه للحصول على إرشادات صوتية أثناء المشي.`);
}

function startNavigation() {
  if (!currentDestination) {
    alert('يرجى اختيار وجهة أولاً');
    return;
  }
  
  isNavigating = true;
  document.getElementById('voice-navigation').classList.add('active');
  document.getElementById('navigation-btn').style.display = 'none';
  document.getElementById('stop-nav-btn').style.display = 'inline-flex';
  
  const initialDistance = calcDistance(
    userLocation[0], userLocation[1], 
    currentDestination.lat, currentDestination.lon
  ) * 1000;
  
  document.getElementById('nav-instruction').textContent = 
    `بدء التوجيه إلى ${currentDestination.name}`;
  document.getElementById('nav-distance').textContent = 
    `المسافة المتبقية: ${Math.round(initialDistance)} متر`;
  
  speak(`بدء التوجيه إلى ${currentDestination.name}. اتبع الخط الأزرق على الخريطة.`);
  
  startLocationTracking();
}

function stopNavigation() {
  isNavigating = false;
  document.getElementById('voice-navigation').classList.remove('active');
  document.getElementById('navigation-btn').style.display = 'inline-flex';
  document.getElementById('stop-nav-btn').style.display = 'none';
  
  if (watchId) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }
  
  lastInstruction = '';
  speak('تم إيقاف التوجيه الصوتي');
}

function speak(text) {
  if ('speechSynthesis' in window) {
    speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'ar-SA';
    utterance.rate = 0.9;
    speechSynthesis.speak(utterance);
  }
}

function calcDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) + 
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// البحث والتصفية
document.getElementById('search-box').oninput = function() {
  const query = this.value.toLowerCase();
  document.querySelectorAll('.place-item').forEach(item => {
    const placeName = item.querySelector('.place-name').textContent.toLowerCase();
    if (placeName.includes(query)) {
      item.style.display = 'flex';
    } else {
      item.style.display = 'none';
    }
  });
};

// البحث الصوتي
document.getElementById('voice-btn').onclick = function() {
  if ('webkitSpeechRecognition' in window) {
    const recognition = new webkitSpeechRecognition();
    recognition.lang = 'ar-SA';
    recognition.start();
    
    recognition.onresult = function(event) {
      const searchTerm = event.results[0][0].transcript;
      document.getElementById('search-box').value = searchTerm;
      document.getElementById('search-box').oninput();
    };
  } else {
    alert('البحث الصوتي غير مدعوم في هذا المتصفح');
  }
};

document.getElementById('navigation-btn').onclick = startNavigation;
document.getElementById('stop-nav-btn').onclick = stopNavigation;

window.onload = function() {
  loadPlaces();
};
</script>

</body>
</html>
