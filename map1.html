<!DOCTYPE HTML>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© - Ù…Ø³Ø§Ø±Ø§Øª Ø³Ù‡Ù„Ø© Ù„Ù„Ø­Ø¬Ø§Ø¬</title>
  <link rel="stylesheet" href="assets/css/main.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <style>
    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù… */
    .container-map { display: flex; flex-direction: column; max-width: 1200px; margin: 30px auto; gap: 20px; padding: 0 20px; position: relative; }
    #map { width: 100%; height: 600px; border-radius: 16px; box-shadow: 0 4px 25px rgba(0,0,0,0.15); }
    #lists { background: linear-gradient(145deg, #c6c6d0, #a7957c); color: #333; padding: 15px; border-radius: 20px; max-height: 600px; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.25); font-family: "Cairo", sans-serif; transition: 0.3s; }
    #lists details { margin-bottom: 14px; border-radius: 14px; overflow: hidden; background: rgba(255,255,255,0.15); box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: all 0.3s; border-left: 5px solid #a7957c; }
    #lists summary { font-weight: bold; font-size: 17px; padding: 12px 16px; background: linear-gradient(to right, #a7957c, #c6c6d0); color: #fff; cursor: pointer; outline: none; border-radius: 12px; }
    .list-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-radius: 12px; margin: 4px 0; background: rgba(255,255,255,0.2); transition: background 0.3s, transform 0.2s; cursor: pointer; }
    .list-item:hover { background: rgba(255,255,255,0.3); transform: translateX(5px); }
    .item-name { flex: 1; margin: 0 8px; display: flex; align-items: center; gap: 10px; font-size: 15px; color: #333; }
    .item-dist { color: #444; font-size: 13px; background: rgba(255,255,255,0.25); padding: 3px 8px; border-radius: 10px; font-weight: bold; }
    .icon { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 16px; border-radius: 50%; background: #a7957c; color: white; flex-shrink: 0; }
    
    /* Ø¥Ø¶Ø§ÙØ© ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø¨Ø§Ù„Ø£Ù„ÙˆØ§Ù† */
    .distance-very-close { background: #28a745 !important; color: white; }
    .distance-close { background: #ffc107 !important; color: #212529; }
    .distance-far { background: #dc3545 !important; color: white; }
    
    /* Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ ÙˆÙ‚Øª Ø§Ù„Ù…Ø´ÙŠ */
    .walking-time { font-size: 11px; color: #666; margin-top: 2px; }
    
    /* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡Ø§Øª */
    .route-instructions { background: #e8f5e8; padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 14px; border-right: 4px solid #28a745; }
    
    #controls { display: flex; flex-direction: row; justify-content: center; gap: 10px; z-index: 1000; }
    #controls button { display: flex; align-items: center; gap: 6px; padding: 10px 18px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; }
    #voice-btn { background-color: #17a2b8; color: #fff; }
    #voice-btn:hover { background-color: #117a8b; }
    #info-btn { background-color: #ffc107; color: #212529; }
    #info-btn:hover { background-color: #e0a800; }
    #info-popup { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: white; padding: 16px 22px; border-radius: 16px; box-shadow: 0 6px 25px rgba(0,0,0,0.25); z-index: 1001; display: none; max-width: 320px; font-family: Cairo, sans-serif; transition: 0.3s; }
    #info-popup button { margin-top: 10px; padding: 6px 12px; font-size: 13px; border: none; border-radius: 10px; background: #4facfe; color: white; cursor: pointer; }
    #search-box { width: 100%; padding: 10px; margin-bottom: 12px; border-radius: 12px; border: none; font-size: 14px; }
    
    /* Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡Ø§Øª */
    #route-guidance { background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 15px; display: none; }
    #route-guidance h4 { margin: 0 0 10px 0; color: #495057; }
  </style>
</head>
<body class="is-preload homepage">

<!-- Intro Screen -->
<div id="intro-screen" style="position: fixed; top:0; left:0; width:100%; height:100%; background:#ffffff; color:#000; display:flex; justify-content:center; align-items:center; flex-direction:column; font-family:sans-serif; z-index:9999;">
  <img src="loading-image.png" alt="ØªØ­Ù…ÙŠÙ„" style="margin-bottom:20px; max-width:200px;">
  <p style="font-size:18px;">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
</div>

<!-- Header -->
<div id="header-wrapper"></div>

<!-- Ø§Ù„Ø®Ø¯Ù…Ø§Øª -->
<div class="services-box"></div>

<!-- Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰ -->
<div class="container-map">
  <div id="map"></div>
  <div id="controls">
    <button id="voice-btn">ğŸ¤ ØªØ­Ø¯Ø«</button>
    <button id="info-btn">â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>
  </div>
  
  <!-- Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡Ø§Øª -->
  <div id="route-guidance">
    <h4>ğŸ§­ ØªÙˆØ¬ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø±</h4>
    <div id="guidance-content"></div>
  </div>
  
  <div id="lists">
    <input type="text" id="search-box" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ù…ÙƒØ§Ù† Ù‡Ù†Ø§..." oninput="filterList()">
  </div>
  <div id="info-popup">
    <strong id="info-title"></strong>
    <p id="info-desc" style="margin-top: 8px; font-size: 14px;"></p>
    <button onclick="document.getElementById('info-popup').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
</div>

<!-- Footer -->
<div id="footer-wrapper"></div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>

<script>
const categories = {
  "Ù…Ø·Ø§Ø¹Ù…": {filter:'amenity=restaurant', icon:'ğŸ´'},
  "ÙÙ†Ø§Ø¯Ù‚": {filter:'tourism=hotel', icon:'ğŸ¨'},
  "Ø£Ø¬Ù‡Ø²Ø© ØµØ±Ø§Ù": {filter:'amenity=atm', icon:'ğŸ§'},
  "ØµÙŠØ¯Ù„ÙŠØ§Øª": {filter:'amenity=pharmacy', icon:'ğŸ’Š'},
  "Ù…Ø³ØªØ´ÙÙŠØ§Øª": {filter:'amenity=hospital', icon:'ğŸ¥'},
  "Ù…ØªØ§Ø¬Ø±": {filter:'shop=*', icon:'ğŸ›ï¸'},
  "Ù…Ù‚Ø§Ù‡ÙŠ": {filter:'amenity=cafe', icon:'â˜•'},
  "Ø¯ÙˆØ±Ø§Øª Ù…ÙŠØ§Ù‡": {filter:'amenity=toilets', icon:'ğŸš»'}
};

const categoryDescriptions = {
  "Ù…Ø·Ø§Ø¹Ù…": "Ù…Ø·Ø§Ø¹Ù…: ØªÙ‚Ø¯Ù… Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ØªÙ†ÙˆØ¹Ø© Ù…Ù† Ø§Ù„Ø£Ø·Ø¹Ù…Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙˆØ§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©.",
  "ÙÙ†Ø§Ø¯Ù‚": "ÙÙ†Ø§Ø¯Ù‚: Ø¥Ù‚Ø§Ù…Ø© Ù…Ø±ÙŠØ­Ø© Ù…Ø¹ Ø®Ø¯Ù…Ø§Øª Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¬ÙˆØ¯Ø©.",
  "Ø£Ø¬Ù‡Ø²Ø© ØµØ±Ø§Ù": "Ø£Ø¬Ù‡Ø²Ø© ØµØ±Ø§Ù: Ø³Ø­Ø¨ ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ù…ÙˆØ§Ù„ Ø¨Ø³Ù‡ÙˆÙ„Ø©.",
  "ØµÙŠØ¯Ù„ÙŠØ§Øª": "ØµÙŠØ¯Ù„ÙŠØ§Øª: Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØµØ­ÙŠØ©.",
  "Ù…Ø³ØªØ´ÙÙŠØ§Øª": "Ù…Ø³ØªØ´ÙÙŠØ§Øª: Ø®Ø¯Ù…Ø§Øª Ø·Ø¨ÙŠØ© Ø·Ø§Ø±Ø¦Ø© ÙˆÙ…Ø³ØªØ¯Ø§Ù…Ø©.",
  "Ù…ØªØ§Ø¬Ø±": "Ù…ØªØ§Ø¬Ø±: Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ØªÙ†ÙˆØ¹Ø© Ù…Ù† Ø§Ù„Ù…Ù„Ø§Ø¨Ø³ ÙˆØ§Ù„Ø¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª.",
  "Ù…Ù‚Ø§Ù‡ÙŠ": "Ù…Ù‚Ø§Ù‡ÙŠ: Ù…ÙƒØ§Ù† Ù„Ù„Ø§Ø³ØªØ±Ø®Ø§Ø¡ ÙˆØ§Ù„Ø§Ø³ØªÙ…ØªØ§Ø¹ Ø¨Ø§Ù„Ù‚Ù‡ÙˆØ©.",
  "Ø¯ÙˆØ±Ø§Øª Ù…ÙŠØ§Ù‡": "Ø¯ÙˆØ±Ø§Øª Ù…ÙŠØ§Ù‡: Ù…ØªØ§Ø­Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø§Ù….",
  "Unknown": "Ø§Ù„ÙˆØµÙ ØºÙŠØ± Ù…ØªÙˆÙØ±."
};

const landmarks = {
  "Ø§Ù„ÙƒØ¹Ø¨Ø© Ø§Ù„Ù…Ø´Ø±ÙØ©": [21.4225, 39.8262],
  "Ø¨Ø§Ø¨ Ø§Ù„Ù…Ù„Ùƒ Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ²": [21.4235, 39.8270],
  "Ø¨Ø§Ø¨ Ø§Ù„ØµÙØ§": [21.4215, 39.8255],
  "Ø§Ù„ØµÙØ§ ÙˆØ§Ù„Ù…Ø±ÙˆØ©": [21.4220, 39.8275],
  "Ù…Ù‚Ø§Ù… Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…": [21.4226, 39.8264]
};

let userLocation = [21.4225,39.8262];
let lang = "ar-SA";
let lastSelectedPlace = null;
const map = L.map('map').setView(userLocation, 16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap contributors' }).addTo(map);
let userMarker = L.marker(userLocation).addTo(map).bindPopup("Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ").openPopup();
let routingControl = null;
let allPlaces = [];
let fuse = null;

// Polygon ÙŠØ­Ø¯Ø¯ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø­Ø±Ù… (Ù…Ø«Ø§Ù„ ØªÙ‚Ø±ÙŠØ¨ÙŠ)
const haramBounds = L.polygon([
  [21.4220, 39.8250],
  [21.4220, 39.8280],
  [21.4245, 39.8280],
  [21.4245, 39.8250]
]).addTo(map);

// Ù…ØªØ§Ø¨Ø¹Ø© Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
if (navigator.geolocation) {
  navigator.geolocation.watchPosition(pos => {
    const newLatLng = [pos.coords.latitude, pos.coords.longitude];
    userMarker.setLatLng(newLatLng).update();
    map.panTo(newLatLng, {animate:true, duration:1.0});
    userLocation = newLatLng;
    if(routingControl && lastSelectedPlace){
      routingControl.setWaypoints([L.latLng(userLocation[0],userLocation[1]), L.latLng(lastSelectedPlace.lat,lastSelectedPlace.lon)]);
    }
  }, err => console.log(err), {enableHighAccuracy:true, maximumAge:1000});
}

function loadPlaces(lat, lon){
  const listsDiv = document.getElementById("lists");
  const searchHTML = listsDiv.querySelector("#search-box").outerHTML;
  listsDiv.innerHTML = searchHTML;
  allPlaces = [];
  
  for(const [name, cat] of Object.entries(categories)){
    const overpassUrl = `https://overpass-api.de/api/interpreter?data=[out:json];node[${cat.filter}](around:3000,${lat},${lon});out;`;
    fetch(overpassUrl)
      .then(res=>res.json())
      .then(data=>{
        const placesWithDistance = data.elements.map((el, index) => {
          const placeLat = el.lat;
          const placeLon = el.lon;
          let placeName = el.tags.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";
          if(name==="Ø£Ø¬Ù‡Ø²Ø© ØµØ±Ø§Ù"){
            const atmNames = ["ØµØ±Ø§Ù Ø§Ù„Ø£Ù‡Ù„ÙŠ 1","ØµØ±Ø§Ù Ø§Ù„Ø£Ù‡Ù„ÙŠ 2","ØµØ±Ø§Ù Ø³Ø§Ù…Ø¨Ø§ 1","ØµØ±Ø§Ù Ø³Ø§Ù…Ø¨Ø§ 2","ØµØ±Ø§Ù Ø§Ù„Ø±ÙŠØ§Ø¶ 1","ØµØ±Ø§Ù Ø§Ù„Ø±ÙŠØ§Ø¶ 2","ØµØ±Ø§Ù Ø§Ù„Ø¬Ø²ÙŠØ±Ø©","ØµØ±Ø§Ù Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡"];
            placeName = atmNames[index % atmNames.length];
          }
          const dist = calcDistance(userLocation[0],userLocation[1],placeLat,placeLon);
          return {
            name: placeName,
            lat: placeLat,
            lon: placeLon,
            category: name,
            distance: dist,
            element: el
          };
        }).sort((a, b) => a.distance - b.distance);
        
        let html = `<details open><summary>${cat.icon} ${name} (<span class="cat-count">${placesWithDistance.length}</span>)</summary>`;
        
        placesWithDistance.forEach(place => {
          allPlaces.push(place);
          const distKm = place.distance.toFixed(2);
          
          let distanceClass = 'distance-far';
          if (place.distance <= 1.0) distanceClass = 'distance-very-close';
          else if (place.distance <= 2.0) distanceClass = 'distance-close';
          
          const walkingTimeMinutes = Math.ceil(place.distance * 12); // 12 Ø¯Ù‚ÙŠÙ‚Ø© Ù„ÙƒÙ„ ÙƒÙŠÙ„ÙˆÙ…ØªØ±
          
          L.marker([place.lat, place.lon]).addTo(map).bindPopup(`${place.name}<br>${distKm} ÙƒÙ… - ${walkingTimeMinutes} Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ø´ÙŠ`);
          
          html += `<div class="list-item" onclick="focusPlace(${place.lat},${place.lon},'${place.name.replace(/'/g, "&#39;")}','${name}')">
            <span class="item-name">
              <span class="icon">${cat.icon}</span>
              <div>
                ${place.name}
                <div class="walking-time">ğŸš¶â€â™‚ï¸ ${walkingTimeMinutes} Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ø´ÙŠ</div>
              </div>
            </span>
            <span class="item-dist ${distanceClass}">${distKm} ÙƒÙ…</span>
          </div>`;
        });
        
        html += "</details>";
        listsDiv.innerHTML += html;
        fuse = new Fuse(allPlaces, {keys:["name"], threshold:0.4});
      });
  }
}

function focusPlace(lat, lon, name, category){
  map.setView([lat, lon],18);
  L.popup().setLatLng([lat,lon]).setContent(name).openOn(map);
  lastSelectedPlace = {name, lat, lon, category};
  if(routingControl) map.removeControl(routingControl);

  // Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„ÙˆØ¬Ù‡Ø© Ø¯Ø§Ø®Ù„ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø­Ø±Ù…
  const targetPoint = L.latLng(lat, lon);
  if(!haramBounds.getBounds().contains(targetPoint)){
    alert("Ø§Ù„ÙˆØ¬Ù‡Ø© Ø®Ø§Ø±Ø¬ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø­Ø±Ù…ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙƒØ§Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ø±Ù….");
    return;
  }

  routingControl = L.Routing.control({
    waypoints:[L.latLng(userLocation[0],userLocation[1]),targetPoint],
    lineOptions:{styles:[{color:'#28a745',opacity:0.8,weight:6}]}, // Ù„ÙˆÙ† Ø£Ø®Ø¶Ø± Ø£ÙƒØ«Ø± ÙˆØ¶ÙˆØ­Ø§Ù‹
    addWaypoints:false,
    draggableWaypoints:false,
    routeWhileDragging:false,
    showAlternatives:false,
    createMarker:()=>null
  }).addTo(map);
  
  showRouteGuidance(userLocation,[lat,lon],name);
  describeRoute(userLocation,[lat,lon],name);
}

function showRouteGuidance(start, end, placeName) {
  const guidanceDiv = document.getElementById('route-guidance');
  const contentDiv = document.getElementById('guidance-content');
  
  const distance = calcDistance(start[0], start[1], end[0], end[1]);
  const walkingTime = Math.ceil(distance * 12);
  
  // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ù‚Ø±Ø¨ Ù…Ø¹Ù„Ù…
  let nearestLandmark = null;
  let minLandmarkDistance = Infinity;
  
  for (const [landmarkName, landmarkCoords] of Object.entries(landmarks)) {
    const landmarkDistance = calcDistance(end[0], end[1], landmarkCoords[0], landmarkCoords[1]);
    if (landmarkDistance < minLandmarkDistance) {
      minLandmarkDistance = landmarkDistance;
      nearestLandmark = landmarkName;
    }
  }
  
  let guidance = `
    <div class="route-instructions">
      <strong>ğŸ“ Ø§Ù„ÙˆØ¬Ù‡Ø©:</strong> ${placeName}<br>
      <strong>ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ©:</strong> ${distance.toFixed(2)} ÙƒÙ…<br>
      <strong>â±ï¸ ÙˆÙ‚Øª Ø§Ù„Ù…Ø´ÙŠ:</strong> ${walkingTime} Ø¯Ù‚ÙŠÙ‚Ø© ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹<br>
      <strong>ğŸ•‹ Ø£Ù‚Ø±Ø¨ Ù…Ø¹Ù„Ù…:</strong> ${nearestLandmark} (${minLandmarkDistance.toFixed(2)} ÙƒÙ… Ù…Ù† Ø§Ù„ÙˆØ¬Ù‡Ø©)
    </div>
  `;
  
  // Ø¥Ø¶Ø§ÙØ© ØªÙˆØ¬ÙŠÙ‡Ø§Øª Ù…Ø¨Ø³Ø·Ø©
  const latDiff = end[0] - start[0];
  const lonDiff = end[1] - start[1];
  
  let direction = "";
  if (Math.abs(latDiff) > Math.abs(lonDiff)) {
    direction = latDiff > 0 ? "Ø´Ù…Ø§Ù„Ø§Ù‹ Ù†Ø­Ùˆ Ø§Ù„ÙƒØ¹Ø¨Ø© Ø§Ù„Ù…Ø´Ø±ÙØ©" : "Ø¬Ù†ÙˆØ¨Ø§Ù‹ Ù…Ù† Ø§Ù„ÙƒØ¹Ø¨Ø© Ø§Ù„Ù…Ø´Ø±ÙØ©";
  } else {
    direction = lonDiff > 0 ? "Ø´Ø±Ù‚Ø§Ù‹ Ù†Ø­Ùˆ Ø§Ù„ØµÙØ§ ÙˆØ§Ù„Ù…Ø±ÙˆØ©" : "ØºØ±Ø¨Ø§Ù‹ Ù…Ù† Ø§Ù„ØµÙØ§ ÙˆØ§Ù„Ù…Ø±ÙˆØ©";
  }
  
  guidance += `
    <div style="background: #e3f2fd; padding: 10px; border-radius: 8px; margin-top: 10px;">
      <strong>ğŸ§­ Ø§Ù„Ø§ØªØ¬Ø§Ù‡:</strong> ${direction}<br>
      <strong>ğŸ’¡ Ù†ØµÙŠØ­Ø©:</strong> Ø§ØªØ¨Ø¹ Ø§Ù„Ø®Ø· Ø§Ù„Ø£Ø®Ø¶Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ø³ØªØ®Ø¯Ù… ${nearestLandmark} ÙƒÙ†Ù‚Ø·Ø© Ù…Ø±Ø¬Ø¹ÙŠØ©
    </div>
  `;
  
  contentDiv.innerHTML = guidance;
  guidanceDiv.style.display = 'block';
}

function describeRoute(start,end,placeName){
  const latDiff=end[0]-start[0];
  const lonDiff=end[1]-start[1];
  const distance = calcDistance(start[0], start[1], end[0], end[1]);
  const walkingTime = Math.ceil(distance * 12);
  
  let text = `ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ ${placeName}. Ø§Ù„Ù…Ø³Ø§ÙØ© ${distance.toFixed(2)} ÙƒÙŠÙ„ÙˆÙ…ØªØ±ØŒ ÙˆÙ‚Øª Ø§Ù„Ù…Ø´ÙŠ ${walkingTime} Ø¯Ù‚ÙŠÙ‚Ø©. `;
  
  // Ø¥Ø¶Ø§ÙØ© Ø§ØªØ¬Ø§Ù‡Ø§Øª Ù…Ø¹ Ù…Ø¹Ø§Ù„Ù…
  if(Math.abs(latDiff)>Math.abs(lonDiff)){
    text += latDiff>0 ? "Ø§ØªØ¬Ù‡ Ø´Ù…Ø§Ù„Ø§Ù‹ Ù†Ø­Ùˆ Ø§Ù„ÙƒØ¹Ø¨Ø© Ø§Ù„Ù…Ø´Ø±ÙØ©. " : "Ø§ØªØ¬Ù‡ Ø¬Ù†ÙˆØ¨Ø§Ù‹ Ù…Ù† Ø§Ù„ÙƒØ¹Ø¨Ø© Ø§Ù„Ù…Ø´Ø±ÙØ©. ";
  } else {
    text += lonDiff>0 ? "Ø§ØªØ¬Ù‡ Ø´Ø±Ù‚Ø§Ù‹ Ù†Ø­Ùˆ Ø§Ù„ØµÙØ§ ÙˆØ§Ù„Ù…Ø±ÙˆØ©. " : "Ø§ØªØ¬Ù‡ ØºØ±Ø¨Ø§Ù‹ Ù…Ù† Ø§Ù„ØµÙØ§ ÙˆØ§Ù„Ù…Ø±ÙˆØ©. ";
  }
  
  text += "Ø§ØªØ¨Ø¹ Ø§Ù„Ø®Ø· Ø§Ù„Ø£Ø®Ø¶Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ù„ÙˆØµÙˆÙ„ Ø¨Ø£Ù…Ø§Ù†.";
  speak(text);
}

function speak(text){
  speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = lang;
  utterance.rate = 0.8; // Ø¥Ø¨Ø·Ø§Ø¡ Ø§Ù„Ø³Ø±Ø¹Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„ÙˆØ¶ÙˆØ­
  speechSynthesis.speak(utterance);
}

function calcDistance(lat1,lon1,lat2,lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

document.getElementById("voice-btn").addEventListener("click",()=>{
  if(!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)){
    alert("Ù…ÙŠØ²Ø© Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù…ØªØµÙØ­Ùƒ");
    return;
  }
  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = lang;
  recognition.start();
  recognition.onresult = function(event){
    const transcript = event.results[0][0].transcript;
    if(fuse){
      const results = fuse.search(transcript);
      if(results.length>0){
        const match = results[0].item;
        focusPlace(match.lat, match.lon, match.name, match.category);
      } else {
        speak("Ø§Ù„Ù…ÙƒØ§Ù† ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
      }
    }
  }
});

document.getElementById("info-btn").addEventListener("click",()=>{
  const popup = document.getElementById("info-popup");
  if(lastSelectedPlace){
    document.getElementById("info-title").innerText = lastSelectedPlace.name;
    document.getElementById("info-desc").innerText = categoryDescriptions[lastSelectedPlace.category] || categoryDescriptions["Unknown"];
    popup.style.display = "block";
  } else {
    alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙƒØ§Ù† Ø£ÙˆÙ„Ø§Ù‹");
  }
});

function filterList(){
  const query = document.getElementById("search-box").value.toLowerCase();
  document.querySelectorAll("#lists details").forEach(detail=>{
    let hasMatch=false;
    detail.querySelectorAll(".list-item").forEach(item=>{
      if(item.innerText.toLowerCase().includes(query)){
        item.style.display="flex";
        hasMatch=true;
      } else {
        item.style.display="none";
      }
    });
  });
}

function toggleLanguageMenu() {
  const menu = document.getElementById('language-menu');
  if (menu.style.display === 'block') { menu.style.display = 'none'; } else { menu.style.display = 'block'; }
}
document.addEventListener('click', function (e) {
  const menu = document.getElementById('language-menu');
  const button = e.target.closest('button');
  if (!e.target.closest('#language-menu') && (!button || button.innerText !== 'ğŸŒ')) { menu.style.display = 'none'; }
});

window.addEventListener("load",()=>{
  setTimeout(()=>{document.getElementById("intro-screen").style.display="none";},1500);
  loadPlaces(userLocation[0],userLocation[1]);
});
</script>
</body>
</html>
